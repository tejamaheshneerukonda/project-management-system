{% extends 'base_employee.html' %}
{% load static %}

{% block title %}Productivity Insights{% endblock %}

{% block page_title %}Productivity Insights{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="startFocusSession()">
        <i class="fas fa-play me-2"></i>Start Focus Session
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="exportReport()">
        <i class="fas fa-download me-2"></i>Export Report
    </button>
    <button type="button" class="btn btn-outline-info" onclick="setGoals()">
        <i class="fas fa-target me-2"></i>Set Goals
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Productivity Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Focus Time Today</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ productivity_patterns.average_focus_time }} min</div>
                        <div class="small text-muted">Average session</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Productivity Score</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">85%</div>
                        <div class="small text-muted">This week</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Distractions</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ productivity_patterns.distraction_frequency }}</div>
                        <div class="small text-muted">per hour</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Break Efficiency</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ productivity_patterns.break_efficiency }}%</div>
                        <div class="small text-muted">Effectiveness</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-coffee fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Focus Sessions Chart -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Focus Sessions (Last 5 Days)</h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportChart('focusChart')">PNG</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportChart('focusChart', 'pdf')">PDF</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <canvas id="focusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Productivity Patterns -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Productivity Patterns</h6>
            </div>
            <div class="card-body">
                <div class="pattern-item mb-3">
                    <h6 class="mb-1">Peak Hours</h6>
                    <div class="d-flex flex-wrap">
                        {% for hour in productivity_patterns.peak_hours %}
                        <span class="badge bg-primary me-1 mb-1">{{ hour }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="pattern-item mb-3">
                    <h6 class="mb-1">Most Productive Day</h6>
                    <span class="badge bg-success">{{ productivity_patterns.most_productive_day }}</span>
                </div>
                
                <div class="pattern-item">
                    <h6 class="mb-1">Average Focus Time</h6>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ productivity_patterns.average_focus_time|floatformat:0|add:"25" }}%"
                             aria-valuenow="{{ productivity_patterns.average_focus_time|floatformat:0|add:"25" }}" 
                             aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">{{ productivity_patterns.average_focus_time }} minutes</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Work Habits Analysis -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Work Habits Analysis</h6>
            </div>
            <div class="card-body">
                <div class="habit-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Early Bird</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" {% if work_habits.early_bird %}checked{% endif %} disabled>
                        </div>
                    </div>
                </div>
                
                <div class="habit-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Night Owl</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" {% if work_habits.night_owl %}checked{% endif %} disabled>
                        </div>
                    </div>
                </div>
                
                <div class="habit-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Prefers Mornings</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" {% if work_habits.prefers_mornings %}checked{% endif %} disabled>
                        </div>
                    </div>
                </div>
                
                <div class="habit-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Takes Regular Breaks</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" {% if work_habits.takes_regular_breaks %}checked{% endif %} disabled>
                        </div>
                    </div>
                </div>
                
                <div class="habit-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Multitasker</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" {% if work_habits.multitasker %}checked{% endif %} disabled>
                        </div>
                    </div>
                </div>
                
                <div class="habit-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Deep Worker</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" {% if work_habits.deep_worker %}checked{% endif %} disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productivity Recommendations -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">AI Recommendations</h6>
            </div>
            <div class="card-body">
                {% for recommendation in recommendations %}
                <div class="recommendation-item mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">{{ recommendation.title }}</h6>
                        <span class="badge bg-{{ recommendation.priority|lower }}">{{ recommendation.priority }}</span>
                    </div>
                    <p class="text-muted mb-2">{{ recommendation.description }}</p>
                    <small class="text-muted">{{ recommendation.category }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Focus Timer -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Focus Timer</h6>
            </div>
            <div class="card-body text-center">
                <div class="focus-timer mb-4">
                    <div class="timer-display">
                        <span id="timerMinutes">25</span>:<span id="timerSeconds">00</span>
                    </div>
                    <div class="timer-controls mt-3">
                        <button type="button" class="btn btn-success me-2" onclick="startTimer()">
                            <i class="fas fa-play me-2"></i>Start
                        </button>
                        <button type="button" class="btn btn-warning me-2" onclick="pauseTimer()">
                            <i class="fas fa-pause me-2"></i>Pause
                        </button>
                        <button type="button" class="btn btn-danger me-2" onclick="stopTimer()">
                            <i class="fas fa-stop me-2"></i>Stop
                        </button>
                        <button type="button" class="btn btn-info" onclick="resetTimer()">
                            <i class="fas fa-redo me-2"></i>Reset
                        </button>
                    </div>
                </div>
                
                <div class="timer-presets">
                    <h6 class="mb-3">Quick Presets</h6>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="setTimer(25)">25 min</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTimer(45)">45 min</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTimer(60)">60 min</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTimer(90)">90 min</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Productivity Tips -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Productivity Tips</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="tip-card p-3 border rounded h-100">
                            <i class="fas fa-clock text-primary fa-2x mb-2"></i>
                            <h6>Time Blocking</h6>
                            <p class="text-muted">Schedule specific time blocks for different types of work to maintain focus.</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="tip-card p-3 border rounded h-100">
                            <i class="fas fa-mobile-alt text-success fa-2x mb-2"></i>
                            <h6>Digital Detox</h6>
                            <p class="text-muted">Turn off notifications during focus sessions to minimize distractions.</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="tip-card p-3 border rounded h-100">
                            <i class="fas fa-coffee text-warning fa-2x mb-2"></i>
                            <h6>Regular Breaks</h6>
                            <p class="text-muted">Take 5-minute breaks every 45 minutes to maintain productivity.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let timerInterval;
let timerRunning = false;
let timerMinutes = 25;
let timerSeconds = 0;

document.addEventListener('DOMContentLoaded', function() {
    initializeFocusChart();
    updateTimerDisplay();
});

function initializeFocusChart() {
    const focusData = {{ focus_sessions|safe }};
    const ctx = document.getElementById('focusChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: focusData.map(item => item.date),
            datasets: [{
                label: 'Focus Duration (min)',
                data: focusData.map(item => item.duration),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }, {
                label: 'Productivity Score',
                data: focusData.map(item => item.productivity_score),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Focus Sessions'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Duration (minutes)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Productivity Score (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

function startFocusSession() {
    console.log('Starting focus session');
    // Implement focus session tracking
}

function exportReport() {
    console.log('Exporting productivity report');
    // Implement report export
}

function setGoals() {
    console.log('Setting productivity goals');
    // Implement goal setting modal
}

function startTimer() {
    if (!timerRunning) {
        timerRunning = true;
        timerInterval = setInterval(updateTimer, 1000);
    }
}

function pauseTimer() {
    if (timerRunning) {
        timerRunning = false;
        clearInterval(timerInterval);
    }
}

function stopTimer() {
    timerRunning = false;
    clearInterval(timerInterval);
    timerMinutes = 25;
    timerSeconds = 0;
    updateTimerDisplay();
}

function resetTimer() {
    stopTimer();
    timerMinutes = 25;
    timerSeconds = 0;
    updateTimerDisplay();
}

function setTimer(minutes) {
    stopTimer();
    timerMinutes = minutes;
    timerSeconds = 0;
    updateTimerDisplay();
}

function updateTimer() {
    if (timerSeconds > 0) {
        timerSeconds--;
    } else if (timerMinutes > 0) {
        timerMinutes--;
        timerSeconds = 59;
    } else {
        // Timer finished
        stopTimer();
        showNotification('Focus session completed!', 'success');
    }
    updateTimerDisplay();
}

function updateTimerDisplay() {
    document.getElementById('timerMinutes').textContent = timerMinutes.toString().padStart(2, '0');
    document.getElementById('timerSeconds').textContent = timerSeconds.toString().padStart(2, '0');
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function exportChart(chartId, format = 'png') {
    console.log('Exporting chart:', chartId, 'as', format);
    // Implement chart export functionality
}
</script>

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/employee_productivity.css' %}">
{% endblock %}
{% endblock %}
