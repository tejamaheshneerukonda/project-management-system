{% extends 'base_company_admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/performance_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-trophy"></i>
                Performance Dashboard
            </h1>
            <p class="page-subtitle">Comprehensive performance management and analytics</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="generatePerformanceReport()">
                <i class="fas fa-chart-bar"></i> Generate Report
            </button>
            <button class="btn btn-success" onclick="createPerformanceReview()">
                <i class="fas fa-plus"></i> New Review
            </button>
        </div>
    </div>

    <!-- Performance Overview Cards -->
    <div class="row mb-2">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="performance-card">
                <div class="card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="card-content">
                    <h3>{{ total_employees }}</h3>
                    <p>Total Employees</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="performance-card">
                <div class="card-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="card-content">
                    <h3>{{ active_reviews }}</h3>
                    <p>Active Reviews</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="performance-card">
                <div class="card-icon">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div class="card-content">
                    <h3>{{ active_goals }}</h3>
                    <p>Active Goals</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="performance-card">
                <div class="card-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="card-content">
                    <h3>{{ overdue_goals }}</h3>
                    <p>Overdue Goals</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Statistics -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="performance-stat-card">
                <div class="stat-header">
                    <h5><i class="fas fa-chart-pie"></i> Review Completion</h5>
                </div>
                <div class="stat-content">
                    <div class="stat-item">
                        <span class="stat-label">Completed Reviews:</span>
                        <span class="stat-value">{{ completed_reviews }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Reviews:</span>
                        <span class="stat-value">{{ active_reviews }}</span>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar" style="width: {% if total_employees > 0 %}{% widthratio completed_reviews|add:active_reviews total_employees 100 %}{% else %}0{% endif %}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-3">
            <div class="performance-stat-card">
                <div class="stat-header">
                    <h5><i class="fas fa-target"></i> Goal Achievement</h5>
                </div>
                <div class="stat-content">
                    <div class="stat-item">
                        <span class="stat-label">Completed Goals:</span>
                        <span class="stat-value">{{ completed_goals }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Goals:</span>
                        <span class="stat-value">{{ active_goals }}</span>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar bg-success" style="width: {% if active_goals|add:completed_goals > 0 %}{% widthratio completed_goals active_goals|add:completed_goals 100 %}{% else %}0{% endif %}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Performance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="performance-section-card">
                <div class="section-header">
                    <h5><i class="fas fa-building"></i> Department Performance</h5>
                </div>
                <div class="section-content">
                    {% if department_performance %}
                        <div class="department-list">
                            {% for dept in department_performance %}
                                <div class="department-item">
                                    <div class="department-info">
                                        <h6>{{ dept.employee__department|default:"No Department" }}</h6>
                                        <p>{{ dept.total_metrics }} metrics recorded</p>
                                    </div>
                                    <div class="department-score">
                                        <span class="score-value">{{ dept.avg_value|floatformat:1 }}</span>
                                        <span class="score-label">Avg Score</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>No performance data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-lg-6 mb-3">
            <div class="performance-section-card">
                <div class="section-header">
                    <h5><i class="fas fa-clock"></i> Recent Reviews</h5>
                    <a href="{% url 'core:performance_reviews' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="section-content">
                    {% if recent_reviews %}
                        <div class="activity-list">
                            {% for review in recent_reviews %}
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6>{{ review.employee.first_name }} {{ review.employee.last_name }}</h6>
                                        <p>{{ review.get_review_type_display }} Review - {{ review.get_status_display }}</p>
                                        <small>{{ review.created_at|date:"M d, Y" }}</small>
                                    </div>
                                    <div class="activity-score">
                                        {% if review.overall_score %}
                                            <span class="score-badge">{{ review.overall_score }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clipboard-check"></i>
                            <p>No recent reviews</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-3">
            <div class="performance-section-card">
                <div class="section-header">
                    <h5><i class="fas fa-bullseye"></i> Recent Goals</h5>
                    <a href="{% url 'core:performance_goals' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="section-content">
                    {% if recent_goals %}
                        <div class="activity-list">
                            {% for goal in recent_goals %}
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-bullseye"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6>{{ goal.employee.first_name }} {{ goal.employee.last_name }}</h6>
                                        <p>{{ goal.title }}</p>
                                        <small>{{ goal.created_at|date:"M d, Y" }}</small>
                                    </div>
                                    <div class="activity-score">
                                        <span class="status-badge status-{{ goal.status|lower }}">{{ goal.get_status_display }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bullseye"></i>
                            <p>No recent goals</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Report Modal -->
<div class="modal fade" id="performanceReportModal" tabindex="-1" aria-labelledby="performanceReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="performanceReportModalLabel">
                    <i class="fas fa-chart-bar"></i> Generate Performance Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportType" class="form-label">Report Type</label>
                                <select class="form-select" id="reportType" name="report_type">
                                    <option value="INDIVIDUAL">Individual Performance</option>
                                    <option value="TEAM">Team Performance</option>
                                    <option value="DEPARTMENT">Department Performance</option>
                                    <option value="COMPANY">Company Performance</option>
                                    <option value="GOAL_TRACKING">Goal Tracking</option>
                                    <option value="REVIEW_SUMMARY">Review Summary</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportPeriod" class="form-label">Report Period</label>
                                <select class="form-select" id="reportPeriod" name="period">
                                    <option value="WEEKLY">Weekly</option>
                                    <option value="MONTHLY">Monthly</option>
                                    <option value="QUARTERLY">Quarterly</option>
                                    <option value="YEARLY">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="start_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="end_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Include Data</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeGoals" name="include_goals" checked>
                            <label class="form-check-label" for="includeGoals">Performance Goals</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeReviews" name="include_reviews" checked>
                            <label class="form-check-label" for="includeReviews">Performance Reviews</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeFeedback" name="include_feedback" checked>
                            <label class="form-check-label" for="includeFeedback">360° Feedback</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeMetrics" name="include_metrics" checked>
                            <label class="form-check-label" for="includeMetrics">Performance Metrics</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-download"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function generatePerformanceReport() {
    const modal = new bootstrap.Modal(document.getElementById('performanceReportModal'));
    modal.show();
}

function createPerformanceReview() {
    // Redirect to create new review page
    window.location.href = "{% url 'core:performance_reviews' %}";
}

function generateReport() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    
    // Add CSRF token
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Show loading state
    const generateBtn = document.querySelector('#performanceReportModal .btn-primary');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    generateBtn.disabled = true;
    
    fetch('{% url "api:generate_performance_report" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Report generated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('performanceReportModal')).hide();
            
            // Download the report
            if (data.report_url) {
                window.open(data.report_url, '_blank');
            }
        } else {
            showNotification(data.error || 'Failed to generate report', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while generating the report', 'error');
    })
    .finally(() => {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    });
}

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
});
</script>
{% endblock %}
