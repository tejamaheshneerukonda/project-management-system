{% extends 'base_company_admin.html' %}
{% load static %}

{% block title %}{{ title }} - {{ company.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/notification_templates.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid notification-templates-wrapper">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1">{{ title }}</h1>
                <p class="text-muted mb-0">Manage notification templates for automated communications</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'core:notification_center' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i>Back to Notifications
                </a>
                <button class="btn btn-primary" onclick="createTemplate()">
                    <i class="fas fa-plus me-1"></i>Create Template
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt text-primary"></i>
                    </div>
                    <h4 class="stat-number">{{ template_stats|length }}</h4>
                    <p class="stat-label">Total Templates</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <h4 class="stat-number">{{ template_stats|length }}</h4>
                    <p class="stat-label">Active Templates</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line text-info"></i>
                    </div>
                    <h4 class="stat-number">{{ template_stats|length }}</h4>
                    <p class="stat-label">Template Types</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon">
                        <i class="fas fa-bell text-warning"></i>
                    </div>
                    <h4 class="stat-number">{{ template_stats|length }}</h4>
                    <p class="stat-label">Notifications Sent</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchTemplates" placeholder="Search templates...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterType">
                        <option value="">All Types</option>
                        {% for value, label in template_type_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Grid -->
    <div class="row" id="templatesGrid">
        {% for stat in template_stats %}
        <div class="col-lg-4 col-md-6 mb-4 template-card" 
             data-type="{{ stat.template.template_type }}" 
             data-status="{% if stat.template.is_active %}active{% else %}inactive{% endif %}"
             data-search="{{ stat.template.get_template_type_display|lower }} {{ stat.template.title_template|lower }}">
            <div class="card template-item h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="template-icon me-2">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div>
                            <h6 class="template-title mb-0">{{ stat.template.get_template_type_display }}</h6>
                            <small class="text-muted">{{ stat.template.template_type }}</small>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="viewTemplate({{ stat.template.id }})">
                                <i class="fas fa-eye me-2"></i>View Details
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="editTemplate({{ stat.template.id }})">
                                <i class="fas fa-edit me-2"></i>Edit Template
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="previewTemplate({{ stat.template.id }})">
                                <i class="fas fa-search me-2"></i>Preview
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="duplicateTemplate({{ stat.template.id }})">
                                <i class="fas fa-copy me-2"></i>Duplicate
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="toggleTemplateStatus({{ stat.template.id }})">
                                <i class="fas fa-toggle-{% if stat.template.is_active %}on{% else %}off{% endif %} me-2"></i>
                                {% if stat.template.is_active %}Deactivate{% else %}Activate{% endif %}
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteTemplate({{ stat.template.id }})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="template-preview">
                        <h6 class="preview-title">{{ stat.template.title_template|truncatechars:50 }}</h6>
                        <p class="preview-message">{{ stat.template.message_template|truncatechars:100 }}</p>
                    </div>
                    
                    <div class="template-meta">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="meta-item">
                                    <i class="fas fa-bell text-primary"></i>
                                    <small class="d-block">{{ stat.usage_count }}</small>
                                    <small class="text-muted">Used</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="meta-item">
                                    <i class="fas fa-flag text-{% if stat.template.priority == 'CRITICAL' %}danger{% elif stat.template.priority == 'HIGH' %}warning{% elif stat.template.priority == 'MEDIUM' %}info{% else %}success{% endif %}"></i>
                                    <small class="d-block">{{ stat.template.get_priority_display }}</small>
                                    <small class="text-muted">Priority</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="meta-item">
                                    <i class="fas fa-paper-plane text-secondary"></i>
                                    <small class="d-block">{{ stat.template.get_channel_display }}</small>
                                    <small class="text-muted">Channel</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="template-status">
                            <span class="badge bg-{% if stat.template.is_active %}success{% else %}secondary{% endif %}">
                                {% if stat.template.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTemplate({{ stat.template.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editTemplate({{ stat.template.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Templates Found</h5>
                    <p class="text-muted">Create your first notification template to get started.</p>
                    <button class="btn btn-primary" onclick="createTemplate()">
                        <i class="fas fa-plus me-1"></i>Create Template
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if template_stats|length > 12 %}
    <nav aria-label="Templates pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item disabled">
                <span class="page-link">Previous</span>
            </li>
            <li class="page-item active">
                <span class="page-link">1</span>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">2</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">3</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Template Details Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Template Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="templateModalBody">
                <!-- Template details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editTemplate()">Edit Template</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div class="modal fade" id="templateFormModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="template_type" class="form-label">Template Type *</label>
                                <select class="form-select" id="template_type" name="template_type" required>
                                    <option value="">Select Type</option>
                                    {% for value, label in template_type_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority *</label>
                                <select class="form-select" id="priority" name="priority" required>
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="HIGH">High</option>
                                    <option value="CRITICAL">Critical</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="title_template" class="form-label">Title Template *</label>
                        <input type="text" class="form-control" id="title_template" name="title_template" required placeholder="e.g., Welcome {{ employee_name }}!">
                        <div class="form-text">Use variables like {{ employee_name }}, {{ company_name }}, etc.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message_template" class="form-label">Message Template *</label>
                        <textarea class="form-control" id="message_template" name="message_template" rows="6" required placeholder="Enter the message template..."></textarea>
                        <div class="form-text">Use variables and formatting as needed.</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email_subject_template" class="form-label">Email Subject Template</label>
                                <input type="text" class="form-control" id="email_subject_template" name="email_subject_template" placeholder="Email subject line">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="channel" class="form-label">Default Channel *</label>
                                <select class="form-select" id="channel" name="channel" required>
                                    <option value="IN_APP" selected>In-App Notification</option>
                                    <option value="EMAIL">Email Notification</option>
                                    <option value="SMS">SMS Notification</option>
                                    <option value="PUSH">Push Notification</option>
                                    <option value="BROWSER">Browser Notification</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email_template" class="form-label">Email Template</label>
                        <textarea class="form-control" id="email_template" name="email_template" rows="4" placeholder="HTML email template (optional)"></textarea>
                        <div class="form-text">HTML content for email notifications.</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Template is active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-fix readability on page load
document.addEventListener('DOMContentLoaded', function() {
    // Apply universal readability fix
    if (typeof applyUniversalReadabilityFix === 'function') {
        applyUniversalReadabilityFix();
    }
    
    // Initialize search and filters
    initializeFilters();
});

// Initialize search and filter functionality
function initializeFilters() {
    const searchInput = document.getElementById('searchTemplates');
    const typeFilter = document.getElementById('filterType');
    const statusFilter = document.getElementById('filterStatus');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterTemplates);
    }
    if (typeFilter) {
        typeFilter.addEventListener('change', filterTemplates);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterTemplates);
    }
}

// Filter templates based on search and filters
function filterTemplates() {
    const searchTerm = document.getElementById('searchTemplates').value.toLowerCase();
    const typeFilter = document.getElementById('filterType').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    const templateCards = document.querySelectorAll('.template-card');
    
    templateCards.forEach(card => {
        const type = card.dataset.type;
        const status = card.dataset.status;
        const search = card.dataset.search;
        
        const matchesSearch = !searchTerm || search.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;
        const matchesStatus = !statusFilter || status === statusFilter;
        
        if (matchesSearch && matchesType && matchesStatus) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Clear all filters
function clearFilters() {
    document.getElementById('searchTemplates').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterStatus').value = '';
    filterTemplates();
}

// Template management functions
function createTemplate() {
    document.getElementById('templateFormModal').querySelector('.modal-title').textContent = 'Create Template';
    document.getElementById('templateForm').reset();
    document.getElementById('is_active').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('templateFormModal'));
    modal.show();
}

function editTemplate(templateId) {
    // TODO: Load template data and populate form
    document.getElementById('templateFormModal').querySelector('.modal-title').textContent = 'Edit Template';
    
    const modal = new bootstrap.Modal(document.getElementById('templateFormModal'));
    modal.show();
}

function viewTemplate(templateId) {
    // TODO: Load template details
    const modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
}

function previewTemplate(templateId) {
    // TODO: Show template preview
    showNotification('Template preview functionality coming soon!', 'info');
}

function duplicateTemplate(templateId) {
    // TODO: Duplicate template
    showNotification('Template duplication functionality coming soon!', 'info');
}

function toggleTemplateStatus(templateId) {
    // TODO: Toggle template status
    showNotification('Template status toggle functionality coming soon!', 'info');
}

function deleteTemplate(templateId) {
    if (confirm('Are you sure you want to delete this template?')) {
        // TODO: Delete template
        showNotification('Template deletion functionality coming soon!', 'info');
    }
}

function saveTemplate() {
    // TODO: Save template
    showNotification('Template saving functionality coming soon!', 'info');
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Apply readability fixes when modals are shown
document.addEventListener('shown.bs.modal', function(event) {
    if (typeof applyUniversalReadabilityFix === 'function') {
        applyUniversalReadabilityFix();
    }
});
</script>

<script>
// Template icon mapping
const templateIcons = {
    'WELCOME': 'fas fa-handshake',
    'BIRTHDAY': 'fas fa-birthday-cake',
    'ANNIVERSARY': 'fas fa-gift',
    'PERFORMANCE_REVIEW': 'fas fa-chart-line',
    'LEAVE_APPROVED': 'fas fa-check-circle',
    'LEAVE_REJECTED': 'fas fa-times-circle',
    'SHIFT_CHANGE': 'fas fa-exchange-alt',
    'DEADLINE_REMINDER': 'fas fa-exclamation-triangle',
    'TASK_ASSIGNED': 'fas fa-tasks',
    'PROJECT_UPDATE': 'fas fa-project-diagram',
    'ATTENDANCE_ALERT': 'fas fa-clock',
    'TIMESHEET_REMINDER': 'fas fa-stopwatch',
    'TRAINING_REMINDER': 'fas fa-graduation-cap',
    'MEETING_REMINDER': 'fas fa-users',
    'POLICY_UPDATE': 'fas fa-file-alt',
    'EMERGENCY_ALERT': 'fas fa-exclamation-circle'
};

// Apply icons to template cards
document.addEventListener('DOMContentLoaded', function() {
    const templateCards = document.querySelectorAll('.template-card');
    templateCards.forEach(card => {
        const templateType = card.dataset.type;
        const iconElement = card.querySelector('.template-icon i');
        if (iconElement && templateIcons[templateType]) {
            iconElement.className = templateIcons[templateType];
        }
    });
});
</script>
{% endblock %}
