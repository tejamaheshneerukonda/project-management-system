{% extends 'base_employee.html' %}
{% load static %}

{% block title %}Task Board{% endblock %}

{% block page_title %}Task Board{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="addNewTask()">
        <i class="fas fa-plus me-2"></i>New Task
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="toggleFilters()">
        <i class="fas fa-filter me-2"></i>Filters
    </button>
    <button type="button" class="btn btn-outline-info" onclick="exportBoard()">
        <i class="fas fa-download me-2"></i>Export
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Filters Panel -->
<div class="row mb-4" id="filtersPanel" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="projectFilter">
                            <option value="">All Projects</option>
                            <!-- Projects will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="priorityFilter">
                            <option value="">All Priorities</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Due Date</label>
                        <select class="form-select" id="dueDateFilter">
                            <option value="">All Dates</option>
                            <option value="overdue">Overdue</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Actions</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="applyFilters()">
                                Apply
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kanban Board -->
<div class="row">
    <!-- To Do Column -->
    <div class="col-lg-3 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-clipboard-list me-2"></i>To Do
                </h6>
                <span class="badge bg-light text-dark">{{ todo_tasks|length }}</span>
            </div>
            <div class="card-body p-2" id="todoColumn">
                {% for task in todo_tasks %}
                <div class="card mb-3 task-card" data-task-id="{{ task.id }}" draggable="true">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">{{ task.title }}</h6>
                            <span class="badge bg-{{ task.priority|lower }}">{{ task.priority }}</span>
                        </div>
                        <p class="card-text text-muted small">{{ task.description|truncatechars:100 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ task.due_date|date:"M d" }}
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="viewTask({{ task.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="moveTask({{ task.id }}, 'IN_PROGRESS')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <p>No tasks to do</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- In Progress Column -->
    <div class="col-lg-3 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-play me-2"></i>In Progress
                </h6>
                <span class="badge bg-light text-dark">{{ in_progress_tasks|length }}</span>
            </div>
            <div class="card-body p-2" id="inProgressColumn">
                {% for task in in_progress_tasks %}
                <div class="card mb-3 task-card" data-task-id="{{ task.id }}" draggable="true">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">{{ task.title }}</h6>
                            <span class="badge bg-{{ task.priority|lower }}">{{ task.priority }}</span>
                        </div>
                        <p class="card-text text-muted small">{{ task.description|truncatechars:100 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ task.due_date|date:"M d" }}
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveTask({{ task.id }}, 'TODO')">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="viewTask({{ task.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="moveTask({{ task.id }}, 'REVIEW')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-play fa-2x mb-2"></i>
                    <p>No tasks in progress</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Review Column -->
    <div class="col-lg-3 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-eye me-2"></i>Review
                </h6>
                <span class="badge bg-light text-dark">{{ review_tasks|length }}</span>
            </div>
            <div class="card-body p-2" id="reviewColumn">
                {% for task in review_tasks %}
                <div class="card mb-3 task-card" data-task-id="{{ task.id }}" draggable="true">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">{{ task.title }}</h6>
                            <span class="badge bg-{{ task.priority|lower }}">{{ task.priority }}</span>
                        </div>
                        <p class="card-text text-muted small">{{ task.description|truncatechars:100 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ task.due_date|date:"M d" }}
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-warning" onclick="moveTask({{ task.id }}, 'IN_PROGRESS')">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="viewTask({{ task.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="moveTask({{ task.id }}, 'DONE')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-eye fa-2x mb-2"></i>
                    <p>No tasks in review</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Done Column -->
    <div class="col-lg-3 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-check me-2"></i>Done
                </h6>
                <span class="badge bg-light text-dark">{{ done_tasks|length }}</span>
            </div>
            <div class="card-body p-2" id="doneColumn">
                {% for task in done_tasks %}
                <div class="card mb-3 task-card" data-task-id="{{ task.id }}" draggable="true">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">{{ task.title }}</h6>
                            <span class="badge bg-{{ task.priority|lower }}">{{ task.priority }}</span>
                        </div>
                        <p class="card-text text-muted small">{{ task.description|truncatechars:100 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ task.due_date|date:"M d" }}
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-info" onclick="moveTask({{ task.id }}, 'REVIEW')">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="viewTask({{ task.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-check fa-2x mb-2"></i>
                    <p>No completed tasks</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Statistics -->
<div class="row mt-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Tasks</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalTasks">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tasks fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Completed</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="completedTasks">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">In Progress</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="inProgressTasks">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-play-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Completion Rate</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="completionRate">0%</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-percentage fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    updateStatistics();
});

function initializeDragAndDrop() {
    const columns = ['todoColumn', 'inProgressColumn', 'reviewColumn', 'doneColumn'];
    
    columns.forEach(columnId => {
        const column = document.getElementById(columnId);
        
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            column.classList.add('drag-over');
        });
        
        column.addEventListener('dragleave', function(e) {
            column.classList.remove('drag-over');
        });
        
        column.addEventListener('drop', function(e) {
            e.preventDefault();
            column.classList.remove('drag-over');
            
            const taskId = e.dataTransfer.getData('text/plain');
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            
            if (taskElement && !column.contains(taskElement)) {
                column.appendChild(taskElement);
                updateTaskStatus(taskId, getStatusFromColumn(columnId));
            }
        });
    });
    
    // Make task cards draggable
    document.querySelectorAll('.task-card').forEach(card => {
        card.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', this.dataset.taskId);
            this.classList.add('dragging');
        });
        
        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });
}

function getStatusFromColumn(columnId) {
    const statusMap = {
        'todoColumn': 'TODO',
        'inProgressColumn': 'IN_PROGRESS',
        'reviewColumn': 'REVIEW',
        'doneColumn': 'DONE'
    };
    return statusMap[columnId];
}

function updateTaskStatus(taskId, newStatus) {
    fetch(`/api/tasks/${taskId}/update-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatistics();
            showAlert('Task status updated successfully!', 'success');
        } else {
            showAlert('Error updating task status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating task status', 'error');
    });
}

function moveTask(taskId, newStatus) {
    updateTaskStatus(taskId, newStatus);
}

function viewTask(taskId) {
    // Implement task view modal
    console.log('Viewing task:', taskId);
}

function addNewTask() {
    // Implement new task modal
    console.log('Adding new task');
}

function toggleFilters() {
    const panel = document.getElementById('filtersPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function applyFilters() {
    // Implement filter logic
    console.log('Applying filters');
}

function clearFilters() {
    // Implement clear filters logic
    document.getElementById('projectFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('dueDateFilter').value = '';
    console.log('Clearing filters');
}

function exportBoard() {
    // Implement board export functionality
    console.log('Exporting board');
}

function updateStatistics() {
    const totalTasks = document.querySelectorAll('.task-card').length;
    const completedTasks = document.querySelectorAll('#doneColumn .task-card').length;
    const inProgressTasks = document.querySelectorAll('#inProgressColumn .task-card').length;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    document.getElementById('totalTasks').textContent = totalTasks;
    document.getElementById('completedTasks').textContent = completedTasks;
    document.getElementById('inProgressTasks').textContent = inProgressTasks;
    document.getElementById('completionRate').textContent = completionRate + '%';
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/employee_kanban.css' %}">
{% endblock %}
{% endblock %}
