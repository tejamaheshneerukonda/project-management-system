{% extends 'base_company_admin.html' %}

{% block title %}{{ title }} - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-calendar-times me-2"></i>{{ title }}
                    </h2>
                    <p class="text-muted mb-0">Manage employee leave requests and approvals</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeaveModal">
                        <i class="fas fa-plus me-1"></i>Add Leave Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_requests }}</h4>
                            <p class="mb-0">Total Requests</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ pending_requests }}</h4>
                            <p class="mb-0">Pending</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ approved_requests }}</h4>
                            <p class="mb-0">Approved</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ leave_requests.paginator.count }}</h4>
                            <p class="mb-0">Showing</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-6">
                            <label for="search" class="form-label">Search Leave Requests</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_query }}" placeholder="Search by employee name or leave type">
                        </div>
                        <div class="col-md-4">
                            <label for="status" class="form-label">Filter by Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Pending</option>
                                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Approved</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Requests -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Leave Requests
                        {% if search_query or status_filter %}
                            <span class="badge bg-secondary ms-2">Filtered Results</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if leave_requests %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Employee</th>
                                        <th>Leave Type</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in leave_requests %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                        {{ request.employee.first_name|first|upper }}
                                                    </div>
                                                    <div>
                                                        <strong>{{ request.employee.first_name }} {{ request.employee.last_name }}</strong>
                                                        <br><small class="text-muted">{{ request.employee.employee_id }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {% if request.leave_type == "SICK_LEAVE" %}
                                                        <i class="fas fa-thermometer-half me-1"></i>Sick Leave
                                                    {% elif request.leave_type == "VACATION" %}
                                                        <i class="fas fa-umbrella-beach me-1"></i>Vacation
                                                    {% elif request.leave_type == "PERSONAL" %}
                                                        <i class="fas fa-user me-1"></i>Personal
                                                    {% elif request.leave_type == "MATERNITY" %}
                                                        <i class="fas fa-baby me-1"></i>Maternity
                                                    {% elif request.leave_type == "PATERNITY" %}
                                                        <i class="fas fa-baby-carriage me-1"></i>Paternity
                                                    {% else %}
                                                        <i class="fas fa-calendar me-1"></i>{{ request.get_leave_type_display }}
                                                    {% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">{{ request.start_date|date:"M d, Y" }}</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">{{ request.end_date|date:"M d, Y" }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ request.total_days }} day{{ request.total_days|pluralize }}</span>
                                            </td>
                                            <td>
                                                {% if request.status == "PENDING" %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Pending
                                                    </span>
                                                {% elif request.status == "APPROVED" %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Approved
                                                    </span>
                                                {% elif request.status == "REJECTED" %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times me-1"></i>Rejected
                                                    </span>
                                                {% elif request.status == "CANCELLED" %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-ban me-1"></i>Cancelled
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-question me-1"></i>{{ request.get_status_display }}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    {% if request.status == "PENDING" %}
                                                        <button class="btn btn-outline-success" onclick="approveLeave({{ request.id }})" title="Approve">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" onclick="rejectLeave({{ request.id }})" title="Reject">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    {% endif %}
                                                    <button class="btn btn-outline-primary" onclick="viewLeave({{ request.id }})" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" onclick="editLeave({{ request.id }})" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if leave_requests.has_other_pages %}
                            <div class="card-footer">
                                <nav aria-label="Leave pagination">
                                    <ul class="pagination pagination-sm justify-content-center mb-0">
                                        {% if leave_requests.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">First</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ leave_requests.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
                                            </li>
                                        {% endif %}
                                        
                                        <li class="page-item active">
                                            <span class="page-link">
                                                Page {{ leave_requests.number }} of {{ leave_requests.paginator.num_pages }}
                                            </span>
                                        </li>
                                        
                                        {% if leave_requests.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ leave_requests.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ leave_requests.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Last</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No leave requests found</h5>
                            <p class="text-muted">
                                {% if search_query or status_filter %}
                                    Try adjusting your search criteria or status filter.
                                {% else %}
                                    Start managing leave requests by adding the first one.
                                {% endif %}
                            </p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeaveModal">
                                <i class="fas fa-plus me-1"></i>Add First Request
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Leave Modal -->
<div class="modal fade" id="addLeaveModal" tabindex="-1" aria-labelledby="addLeaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLeaveModalLabel">
                    <i class="fas fa-plus me-2"></i>Add Leave Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addLeaveForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="employee" class="form-label">Employee *</label>
                            <select class="form-select" id="employee" name="employee" required>
                                <option value="">Select Employee</option>
                                {% for employee in employees %}
                                    <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }} ({{ employee.employee_id }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="leave_type" class="form-label">Leave Type *</label>
                            <select class="form-select" id="leave_type" name="leave_type" required>
                                <option value="">Select Leave Type</option>
                                {% for value, label in leave_type_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="start_date" class="form-label">Start Date *</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="end_date" class="form-label">End Date *</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>
                        <div class="col-md-12">
                            <label for="reason" class="form-label">Reason *</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="Please provide a reason for the leave request" required></textarea>
                        </div>
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="urgent" name="urgent">
                                <label class="form-check-label" for="urgent">
                                    Mark as urgent request
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addLeave()">
                    <i class="fas fa-plus me-1"></i>Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 12px;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
    }
}
</style>

{% block extra_js %}
<script>
function addLeave() {
    const form = document.getElementById('addLeaveForm');
    const formData = new FormData(form);
    
    fetch('{% url "api:create_leave" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
            } else {
                showErrorToast('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorToast('An error occurred while adding the leave request.');
        });
}

function approveLeave(requestId) {
    if (confirm('Are you sure you want to approve this leave request?')) {
        // TODO: Implement leave approval API call
        fetch(`/api/leave/${requestId}/approve/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showSuccessToast('Leave request approved successfully!');
                location.reload();
            } else {
                showErrorToast('Error approving leave request: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorToast('Error approving leave request. Please try again.');
        });
    }
}

function rejectLeave(requestId) {
    if (confirm('Are you sure you want to reject this leave request?')) {
        // TODO: Implement leave rejection API call
        fetch(`/api/leave/${requestId}/reject/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showSuccessToast('Leave request rejected successfully!');
                location.reload();
            } else {
                showErrorToast('Error rejecting leave request: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorToast('Error rejecting leave request. Please try again.');
        });
    }
}

function viewLeave(requestId) {
    // Redirect to leave details page
    window.location.href = `/company/leave-management/${requestId}/details/`;
}

function editLeave(requestId) {
    // Redirect to edit page
    window.location.href = `/company/leave-management/${requestId}/edit/`;
}

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
    
    document.getElementById('start_date').value = today;
    document.getElementById('end_date').value = tomorrow;
    
    // Initialize WebSocket for real-time updates
    initLeaveRequestWebSocket();
});

// WebSocket for real-time leave request updates
if (typeof leaveRequestSocket === 'undefined') {
    var leaveRequestSocket = null;
}

if (typeof pollingInterval === 'undefined') {
    var pollingInterval = null;
}

if (typeof lastUpdateTime === 'undefined') {
    var lastUpdateTime = null;
}

function initLeaveRequestWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/leave-requests/`;
    
    try {
        leaveRequestSocket = new WebSocket(wsUrl);
        
        leaveRequestSocket.onopen = function(e) {
            console.log('Leave request WebSocket connected');
            // Stop polling if WebSocket connects
            if (typeof pollingInterval !== 'undefined' && pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            // Join company-specific room
            if (leaveRequestSocket.readyState === WebSocket.OPEN) {
                leaveRequestSocket.send(JSON.stringify({
                    action: 'join_company',
                    company_id: {{ company.id }}
                }));
            }
        };
        
        leaveRequestSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'leave_request_update') {
                handleLeaveRequestUpdate(data);
            }
        };
        
        leaveRequestSocket.onclose = function(e) {
            console.log('Leave request WebSocket disconnected');
            // Start polling as fallback
            startPollingFallback();
            // Attempt to reconnect after 3 seconds
            setTimeout(initLeaveRequestWebSocket, 3000);
        };
        
        leaveRequestSocket.onerror = function(e) {
            console.error('Leave request WebSocket error:', e);
            // Start polling as fallback
            startPollingFallback();
        };
    } catch (error) {
        console.error('Failed to create WebSocket:', error);
        // Start polling as fallback
        startPollingFallback();
    }
}

function startPollingFallback() {
    if (typeof pollingInterval !== 'undefined' && pollingInterval) return; // Already polling
    
    console.log('Starting polling fallback for leave requests');
    pollingInterval = setInterval(() => {
        checkForNewLeaveRequests();
    }, 5000); // Poll every 5 seconds
}

function stopPollingFallback() {
    if (typeof pollingInterval !== 'undefined' && pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('Stopped polling fallback');
    }
}

function checkForNewLeaveRequests() {
    // Simple polling to check for new requests
    fetch('/company/leave-management/?ajax=1', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.new_requests) {
            data.new_requests.forEach(request => {
                handleLeaveRequestUpdate({
                    action: 'new_request',
                    data: request
                });
            });
        }
    })
    .catch(error => {
        console.error('Polling error:', error);
    });
}

function handleLeaveRequestUpdate(data) {
    if (data.action === 'new_request') {
        // Add new request to the table
        addNewLeaveRequestToTable(data.data);
        // Update statistics
        updateLeaveRequestStats();
        // Show notification
        showSuccessToast(`New leave request from ${data.data.employee_name}`);
    } else if (data.action === 'status_update') {
        // Update existing request status
        updateLeaveRequestStatus(data.data.id, data.data.status);
        // Update statistics
        updateLeaveRequestStats();
    }
}

function addNewLeaveRequestToTable(requestData) {
    const tbody = document.querySelector('#leaveRequestsTable tbody');
    if (!tbody) return;
    
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>${requestData.employee_name}</td>
        <td><span class="badge bg-info">${requestData.leave_type}</span></td>
        <td>${requestData.start_date}</td>
        <td>${requestData.end_date}</td>
        <td><span class="badge bg-secondary">${requestData.total_days} days</span></td>
        <td>${requestData.reason}</td>
        <td><span class="badge bg-warning">Pending</span></td>
        <td>${requestData.created_at}</td>
        <td>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="viewLeave(${requestData.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-success" onclick="approveLeave(${requestData.id})">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="rejectLeave(${requestData.id})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
    `;
    
    // Insert at the top of the table
    tbody.insertBefore(newRow, tbody.firstChild);
}

function updateLeaveRequestStatus(requestId, newStatus) {
    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
    if (!row) return;
    
    const statusCell = row.querySelector('.badge');
    if (statusCell) {
        statusCell.textContent = newStatus;
        statusCell.className = `badge ${getStatusBadgeClass(newStatus)}`;
    }
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'PENDING': return 'bg-warning';
        case 'APPROVED': return 'bg-success';
        case 'REJECTED': return 'bg-danger';
        case 'CANCELLED': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function updateLeaveRequestStats() {
    // Refresh the page to get updated statistics
    // In a production app, you'd update the stats via AJAX
    setTimeout(() => {
        location.reload();
    }, 1000);
}
</script>
{% endblock %}
{% endblock %}
