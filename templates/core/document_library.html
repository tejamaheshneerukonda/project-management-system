{% extends 'base_company_admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/document_library.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-folder-open"></i>
                Document Library
            </h1>
            <p class="page-subtitle">Manage and organize company documents</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="uploadDocument()">
                <i class="fas fa-upload"></i> Upload Document
            </button>
            <button class="btn btn-success" onclick="createCategory()">
                <i class="fas fa-plus"></i> Create Category
            </button>
        </div>
    </div>

    <!-- Document Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="document-stat-card total">
                <div class="stat-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_documents }}</h3>
                    <p>Total Documents</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="document-stat-card size">
                <div class="stat-icon">
                    <i class="fas fa-hdd"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_size|filesizeformat }}</h3>
                    <p>Total Size</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="document-stat-card categories">
                <div class="stat-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ categories.count }}</h3>
                    <p>Categories</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="document-stat-card recent">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ recent_documents.count }}</h3>
                    <p>Recent Uploads</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="document-filters-card">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> Filters & Search</h5>
                </div>
                <div class="card-content">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_query }}" placeholder="Search documents...">
                        </div>
                        <div class="col-md-2">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="document_type" class="form-label">Type</label>
                            <select class="form-select" id="document_type" name="document_type">
                                <option value="">All Types</option>
                                {% for value, label in document_type_choices %}
                                    <option value="{{ value }}" {% if document_type_filter == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="access_level" class="form-label">Access Level</label>
                            <select class="form-select" id="access_level" name="access_level">
                                <option value="">All Levels</option>
                                {% for value, label in access_level_choices %}
                                    <option value="{{ value }}" {% if access_level_filter == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sort" class="form-label">Sort By</label>
                            <select class="form-select" id="sort" name="sort">
                                <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Newest First</option>
                                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Oldest First</option>
                                <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title A-Z</option>
                                <option value="-title" {% if sort_by == '-title' %}selected{% endif %}>Title Z-A</option>
                                <option value="-file_size" {% if sort_by == '-file_size' %}selected{% endif %}>Largest First</option>
                                <option value="file_size" {% if sort_by == 'file_size' %}selected{% endif %}>Smallest First</option>
                                <option value="-last_accessed" {% if sort_by == '-last_accessed' %}selected{% endif %}>Most Accessed</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Grid -->
    <div class="row">
        <div class="col-lg-8">
            <div class="document-grid-card">
                <div class="card-header">
                    <h5><i class="fas fa-th-large"></i> Documents</h5>
                    <div class="view-toggle">
                        <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('grid')">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleView('list')">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    {% if documents %}
                        <div class="document-grid" id="documentGrid">
                            {% for document in documents %}
                                <div class="document-item" data-document-id="{{ document.id }}">
                                    <div class="document-preview">
                                        {% if document.document_type == 'PDF' %}
                                            <i class="fas fa-file-pdf document-icon pdf"></i>
                                        {% elif document.document_type == 'IMAGE' %}
                                            <i class="fas fa-file-image document-icon image"></i>
                                        {% elif document.document_type == 'VIDEO' %}
                                            <i class="fas fa-file-video document-icon video"></i>
                                        {% elif document.document_type == 'AUDIO' %}
                                            <i class="fas fa-file-audio document-icon audio"></i>
                                        {% elif document.document_type == 'SPREADSHEET' %}
                                            <i class="fas fa-file-excel document-icon spreadsheet"></i>
                                        {% elif document.document_type == 'PRESENTATION' %}
                                            <i class="fas fa-file-powerpoint document-icon presentation"></i>
                                        {% else %}
                                            <i class="fas fa-file document-icon default"></i>
                                        {% endif %}
                                    </div>
                                    <div class="document-info">
                                        <h6 class="document-title">{{ document.title }}</h6>
                                        <p class="document-description">{{ document.description|truncatechars:100 }}</p>
                                        <div class="document-meta">
                                            <span class="document-type">{{ document.get_document_type_display }}</span>
                                            <span class="document-size">{{ document.file_size_formatted }}</span>
                                            <span class="document-date">{{ document.created_at|date:"M d, Y" }}</span>
                                        </div>
                                        <div class="document-tags">
                                            {% for tag in document.tags %}
                                                <span class="tag">{{ tag }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="document-actions">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{% url 'core:document_detail' document.id %}">
                                                    <i class="fas fa-eye me-2"></i>View Details
                                                </a></li>
                                                <li><a class="dropdown-item" href="{{ document.file.url }}" target="_blank">
                                                    <i class="fas fa-download me-2"></i>Download
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="shareDocument({{ document.id }})">
                                                    <i class="fas fa-share me-2"></i>Share
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="editDocument({{ document.id }})">
                                                    <i class="fas fa-edit me-2"></i>Edit
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument({{ document.id }})">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="document-status">
                                        {% if document.access_level == 'PUBLIC' %}
                                            <span class="status-badge public">Public</span>
                                        {% elif document.access_level == 'INTERNAL' %}
                                            <span class="status-badge internal">Internal</span>
                                        {% elif document.access_level == 'CONFIDENTIAL' %}
                                            <span class="status-badge confidential">Confidential</span>
                                        {% elif document.access_level == 'RESTRICTED' %}
                                            <span class="status-badge restricted">Restricted</span>
                                        {% endif %}
                                        
                                        {% if document.is_featured %}
                                            <span class="status-badge featured">Featured</span>
                                        {% endif %}
                                        
                                        {% if document.is_expired %}
                                            <span class="status-badge expired">Expired</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Pagination -->
                        {% if documents.has_other_pages %}
                            <nav aria-label="Document pagination" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    {% if documents.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if document_type_filter %}&document_type={{ document_type_filter }}{% endif %}{% if access_level_filter %}&access_level={{ access_level_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ documents.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if document_type_filter %}&document_type={{ document_type_filter }}{% endif %}{% if access_level_filter %}&access_level={{ access_level_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Previous</a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in documents.paginator.page_range %}
                                        {% if documents.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > documents.number|add:'-3' and num < documents.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if document_type_filter %}&document_type={{ document_type_filter }}{% endif %}{% if access_level_filter %}&access_level={{ access_level_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if documents.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ documents.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if document_type_filter %}&document_type={{ document_type_filter }}{% endif %}{% if access_level_filter %}&access_level={{ access_level_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Next</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ documents.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if document_type_filter %}&document_type={{ document_type_filter }}{% endif %}{% if access_level_filter %}&access_level={{ access_level_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Last</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h5>No Documents Found</h5>
                            <p>No documents match your current filters. Try adjusting your search criteria or upload a new document.</p>
                            <button class="btn btn-primary" onclick="uploadDocument()">
                                <i class="fas fa-upload"></i> Upload Document
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Recent Documents -->
            <div class="recent-documents-card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Recent Documents</h5>
                </div>
                <div class="card-content">
                    {% if recent_documents %}
                        <div class="recent-documents-list">
                            {% for document in recent_documents %}
                                <div class="recent-document-item">
                                    <div class="document-icon">
                                        {% if document.document_type == 'PDF' %}
                                            <i class="fas fa-file-pdf text-danger"></i>
                                        {% elif document.document_type == 'IMAGE' %}
                                            <i class="fas fa-file-image text-success"></i>
                                        {% elif document.document_type == 'VIDEO' %}
                                            <i class="fas fa-file-video text-primary"></i>
                                        {% elif document.document_type == 'AUDIO' %}
                                            <i class="fas fa-file-audio text-warning"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="document-info">
                                        <h6>{{ document.title|truncatechars:30 }}</h6>
                                        <small>{{ document.created_at|timesince }} ago</small>
                                    </div>
                                    <div class="document-actions">
                                        <a href="{% url 'core:document_detail' document.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No recent documents</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Most Accessed -->
            <div class="most-accessed-card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Most Accessed</h5>
                </div>
                <div class="card-content">
                    {% if most_accessed %}
                        <div class="most-accessed-list">
                            {% for document in most_accessed %}
                                <div class="most-accessed-item">
                                    <div class="document-icon">
                                        {% if document.document_type == 'PDF' %}
                                            <i class="fas fa-file-pdf text-danger"></i>
                                        {% elif document.document_type == 'IMAGE' %}
                                            <i class="fas fa-file-image text-success"></i>
                                        {% elif document.document_type == 'VIDEO' %}
                                            <i class="fas fa-file-video text-primary"></i>
                                        {% elif document.document_type == 'AUDIO' %}
                                            <i class="fas fa-file-audio text-warning"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="document-info">
                                        <h6>{{ document.title|truncatechars:30 }}</h6>
                                        <small>{{ document.view_count }} views</small>
                                    </div>
                                    <div class="document-actions">
                                        <a href="{% url 'core:document_detail' document.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>No access data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Modal -->
<div class="modal fade" id="quickActionsModal" tabindex="-1" aria-labelledby="quickActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickActionsModalLabel">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="quick-action-item" onclick="uploadDocument()">
                            <div class="action-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <div class="action-content">
                                <h6>Upload Document</h6>
                                <p>Upload a new document to the library</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="quick-action-item" onclick="createCategory()">
                            <div class="action-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="action-content">
                                <h6>Create Category</h6>
                                <p>Create a new document category</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="quick-action-item" onclick="window.location.href='{% url 'core:document_templates' %}'">
                            <div class="action-icon">
                                <i class="fas fa-file-code"></i>
                            </div>
                            <div class="action-content">
                                <h6>Manage Templates</h6>
                                <p>View and edit document templates</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="quick-action-item" onclick="window.location.href='{% url 'core:document_analytics' %}'">
                            <div class="action-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="action-content">
                                <h6>View Analytics</h6>
                                <p>View document usage analytics</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function uploadDocument() {
    window.location.href = "{% url 'core:upload_document' %}";
}

function createCategory() {
    window.location.href = "{% url 'core:document_categories' %}";
}

function toggleView(view) {
    const gridButton = document.querySelector('button[onclick="toggleView(\'grid\')"]');
    const listButton = document.querySelector('button[onclick="toggleView(\'list\')"]');
    const documentGrid = document.getElementById('documentGrid');
    
    if (view === 'grid') {
        gridButton.classList.add('active');
        listButton.classList.remove('active');
        documentGrid.classList.remove('list-view');
        documentGrid.classList.add('grid-view');
    } else {
        listButton.classList.add('active');
        gridButton.classList.remove('active');
        documentGrid.classList.remove('grid-view');
        documentGrid.classList.add('list-view');
    }
}

function shareDocument(documentId) {
    // Implement document sharing functionality
    window.location.href = `/company/documents/${documentId}/share/`;
}

function editDocument(documentId) {
    // Implement document editing functionality
    window.location.href = `/company/documents/${documentId}/edit/`;
}

function deleteDocument(documentId) {
    if (confirm('Are you sure you want to delete this document?')) {
        // Implement document deletion functionality
        showInfoToast('Document deletion functionality will be implemented');
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for document items
    document.querySelectorAll('.document-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't trigger if clicking on buttons or dropdowns
            if (e.target.closest('.btn') || e.target.closest('.dropdown')) {
                return;
            }
            
            const documentId = this.dataset.documentId;
            window.location.href = `{% url 'core:document_detail' 0 %}`.replace('0', documentId);
        });
    });
    
    // Add hover effects
    document.querySelectorAll('.document-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}
