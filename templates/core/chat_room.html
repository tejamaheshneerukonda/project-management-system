{% extends 'base_employee.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: white;
    }
    
    .chat-input {
        background: white;
        border-top: 1px solid #e9ecef;
        padding: 20px;
    }
    
    .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
    }
    
    .message.own {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        margin: 0 10px;
    }
    
    .message-content {
        max-width: 70%;
        background: #f1f3f4;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
    }
    
    .message.own .message-content {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }
    
    .message-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .message-sender {
        font-weight: 600;
        font-size: 13px;
        color: #2c3e50;
    }
    
    .message.own .message-sender {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .message-time {
        font-size: 11px;
        color: #6c757d;
        margin-left: 8px;
    }
    
    .message.own .message-time {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .message-text {
        margin: 0;
        line-height: 1.4;
        word-wrap: break-word;
    }
    
    .message-actions {
        position: absolute;
        top: -10px;
        right: 10px;
        background: white;
        border-radius: 20px;
        padding: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .message:hover .message-actions {
        opacity: 1;
    }
    
    .message-actions button {
        border: none;
        background: none;
        padding: 5px 8px;
        border-radius: 4px;
        color: #6c757d;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .message-actions button:hover {
        background: #f8f9fa;
        color: #2c3e50;
    }
    
    .reply-message {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        font-size: 13px;
    }
    
    .reply-sender {
        font-weight: 600;
        color: #1976d2;
        margin-bottom: 2px;
    }
    
    .reply-content {
        color: #424242;
    }
    
    .typing-indicator {
        display: none;
        padding: 10px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    .typing-indicator.show {
        display: block;
    }
    
    .participants-sidebar {
        width: 250px;
        background: white;
        border-left: 1px solid #e9ecef;
        padding: 20px;
    }
    
    .participant-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .participant-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        margin-right: 10px;
        position: relative;
    }
    
    .online-dot {
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        border: 2px solid white;
        position: absolute;
        bottom: 0;
        right: 0;
    }
    
    .input-group {
        position: relative;
    }
    
    .input-group .btn {
        border-radius: 0 8px 8px 0;
    }
    
    .input-group .form-control {
        border-radius: 8px 0 0 8px;
        border-right: none;
    }
    
    .attachment-btn {
        position: absolute;
        right: 60px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 5px;
    }
    
    .attachment-btn:hover {
        color: #2c3e50;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="d-flex align-items-center">
            <a href="{% url 'core:chat_dashboard' %}" class="btn btn-outline-light btn-sm me-3">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="room-avatar me-3">
                {{ room.name|first|upper }}
            </div>
            <div>
                <h5 class="mb-0">{{ room.name }}</h5>
                <small class="opacity-75">
                    {{ participants|length }} participant{{ participants|length|pluralize }}
                    <span class="mx-2">â€¢</span>
                    {{ room.get_room_type_display }}
                </small>
            </div>
        </div>
        <div>
            <button class="btn btn-outline-light btn-sm" onclick="toggleParticipants()">
                <i class="fas fa-users"></i>
            </button>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="d-flex flex-grow-1">
        <div class="flex-grow-1 d-flex flex-column">
            <!-- Messages -->
            <div class="chat-messages" id="chatMessages">
                {% for message in messages %}
                <div class="message {% if message.sender.id == employee.id %}own{% endif %}" data-message-id="{{ message.id }}">
                    <div class="message-avatar">
                        {{ message.sender.first_name|first|upper }}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">{{ message.sender.first_name }} {{ message.sender.last_name }}</span>
                            <span class="message-time">{{ message.created_at|date:"H:i" }}</span>
                        </div>
                        
                        {% if message.reply_to %}
                        <div class="reply-message">
                            <div class="reply-sender">{{ message.reply_to.sender.first_name }} {{ message.reply_to.sender.last_name }}</div>
                            <div class="reply-content">{{ message.reply_to.content|truncatechars:50 }}</div>
                        </div>
                        {% endif %}
                        
                        <div class="message-text">{{ message.content }}</div>
                        
                        {% if message.is_edited %}
                        <small class="text-muted">
                            <i class="fas fa-edit"></i> edited
                        </small>
                        {% endif %}
                        
                        {% if message.sender.id == employee.id %}
                        <div class="message-actions">
                            <button onclick="editMessage({{ message.id }})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMessage({{ message.id }})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <i class="fas fa-circle"></i>
                <i class="fas fa-circle"></i>
                <i class="fas fa-circle"></i>
                Someone is typing...
            </div>
            
            <!-- Input Area -->
            <div class="chat-input">
                <form id="messageForm" onsubmit="sendMessage(event)">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="Type your message..." autocomplete="off" required>
                        <button type="button" class="attachment-btn" onclick="attachFile()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Participants Sidebar -->
        <div class="participants-sidebar" id="participantsSidebar" style="display: none;">
            <h6 class="mb-3">
                <i class="fas fa-users me-2"></i>
                Participants ({{ participants|length }})
            </h6>
            {% for participant in participants %}
            <div class="participant-item">
                <div class="participant-avatar">
                    {{ participant.first_name|first|upper }}
                    <div class="online-dot"></div>
                </div>
                <div>
                    <div class="fw-bold">{{ participant.first_name }} {{ participant.last_name }}</div>
                    <small class="text-muted">{{ participant.position|default:"Employee" }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal fade" id="editMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="editMessageText" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEditMessage()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentRoomId = {{ room.id }};
let currentEmployeeId = {{ employee.id }};
let editingMessageId = null;
let typingTimer = null;
let isTyping = false;
let socket = null;

// WebSocket connection
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/room/${currentRoomId}/`;
    
    socket = new WebSocket(wsUrl);
    
    socket.onopen = function(e) {
        console.log('WebSocket connected');
    };
    
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        switch(data.type) {
            case 'chat_message':
                addMessageToChat(data.message);
                scrollToBottom();
                break;
            case 'typing':
                showTypingIndicator(data.user, data.user_id);
                break;
            case 'stop_typing':
                hideTypingIndicator(data.user_id);
                break;
            case 'error':
                showErrorToast(data.message);
                break;
        }
    };
    
    socket.onclose = function(e) {
        console.log('WebSocket disconnected');
        // Attempt to reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
    };
    
    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
}

// Send message via WebSocket
function sendMessage(event) {
    event.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'chat_message',
            content: content
        }));
        
        messageInput.value = '';
        scrollToBottom();
    } else {
        // Fallback to HTTP if WebSocket is not available
        sendMessageHTTP(content);
    }
}

// Fallback HTTP method
function sendMessageHTTP(content) {
    const formData = new FormData();
    formData.append('content', content);
    formData.append('message_type', 'TEXT');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/employee/chat/room/${currentRoomId}/send/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addMessageToChat(data);
            scrollToBottom();
        } else {
            showErrorToast('Failed to send message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Error sending message');
    });
}

// Typing indicator
function handleTyping() {
    if (!isTyping && socket && socket.readyState === WebSocket.OPEN) {
        isTyping = true;
        socket.send(JSON.stringify({
            type: 'typing'
        }));
    }
    
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        if (isTyping && socket && socket.readyState === WebSocket.OPEN) {
            isTyping = false;
            socket.send(JSON.stringify({
                type: 'stop_typing'
            }));
        }
    }, 1000);
}

// Show typing indicator
function showTypingIndicator(user, userId) {
    if (userId === currentEmployeeId) return; // Don't show own typing
    
    const indicator = document.getElementById('typingIndicator');
    indicator.innerHTML = `<i class="fas fa-circle"></i><i class="fas fa-circle"></i><i class="fas fa-circle"></i>${user} is typing...`;
    indicator.classList.add('show');
}

// Hide typing indicator
function hideTypingIndicator(userId) {
    if (userId === currentEmployeeId) return;
    
    const indicator = document.getElementById('typingIndicator');
    indicator.classList.remove('show');
}

// Auto-scroll to bottom
function scrollToBottom() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Add message to chat
function addMessageToChat(data) {
    const messagesContainer = document.getElementById('chatMessages');
    const isOwnMessage = data.sender_id === currentEmployeeId;
    
    const messageHtml = `
        <div class="message ${isOwnMessage ? 'own' : ''}" data-message-id="${data.id}">
            <div class="message-avatar">
                ${data.sender_name.charAt(0).toUpperCase()}
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">${data.sender_name}</span>
                    <span class="message-time">${data.created_at}</span>
                </div>
                <div class="message-text">${data.content}</div>
                ${data.is_edited ? '<small class="text-muted"><i class="fas fa-edit"></i> edited</small>' : ''}
                ${isOwnMessage ? `
                    <div class="message-actions">
                        <button onclick="editMessage(${data.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMessage(${data.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
}

// Edit message
function editMessage(messageId) {
    editingMessageId = messageId;
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    const messageText = messageElement.querySelector('.message-text').textContent;
    
    document.getElementById('editMessageText').value = messageText;
    new bootstrap.Modal(document.getElementById('editMessageModal')).show();
}

// Save edited message
function saveEditMessage() {
    const newContent = document.getElementById('editMessageText').value.trim();
    
    if (!newContent) {
        showErrorToast('Message content is required');
        return;
    }
    
    const formData = new FormData();
    formData.append('content', newContent);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/employee/chat/message/${editingMessageId}/edit/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${editingMessageId}"]`);
            const messageText = messageElement.querySelector('.message-text');
            messageText.textContent = newContent;
            
            // Add edited indicator
            if (!messageElement.querySelector('.text-muted')) {
                messageText.insertAdjacentHTML('afterend', 
                    '<small class="text-muted"><i class="fas fa-edit"></i> edited</small>');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('editMessageModal')).hide();
            showSuccessToast('Message updated successfully');
        } else {
            showErrorToast('Failed to update message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Error updating message');
    });
}

// Delete message
function deleteMessage(messageId) {
    if (confirm('Are you sure you want to delete this message?')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/employee/chat/message/${messageId}/delete/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                messageElement.remove();
                showSuccessToast('Message deleted successfully');
            } else {
                showErrorToast('Failed to delete message: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorToast('Error deleting message');
        });
    }
}

// Toggle participants sidebar
function toggleParticipants() {
    const sidebar = document.getElementById('participantsSidebar');
    sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
}

// Attach file
function attachFile() {
    showInfoToast('File attachment feature coming soon!');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Connect WebSocket
    connectWebSocket();
    
    // Add typing event listener
    document.getElementById('messageInput').addEventListener('input', handleTyping);
    
    // Focus on input
    document.getElementById('messageInput').focus();
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (socket) {
            socket.close();
        }
    });
});
</script>
{% endblock %}
