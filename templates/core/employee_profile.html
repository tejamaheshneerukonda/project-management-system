{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ employee.first_name }} {{ employee.last_name }} - Employee Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/employee_profile.css' %}">
{% endblock %}

{% block content %}
<div class="employee-profile-wrapper">
    <!-- Animated Background -->
    <div class="bg-animation">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
        <div class="floating-shape shape-4"></div>
        <div class="floating-shape shape-5"></div>
    </div>

    <div class="container-fluid">
        <!-- Header Section -->
        <div class="profile-header-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="employee-info">
                        <div class="employee-avatar-large">
                            <span>{{ employee.first_name|first }}{{ employee.last_name|first }}</span>
                        </div>
                        <div class="employee-details">
                            <h1 class="employee-name">{{ employee.first_name }} {{ employee.last_name }}</h1>
                            <p class="employee-title">{{ employee.position|default:"Position not specified" }}</p>
                            <p class="employee-department">{{ employee.department|default:"Department not specified" }}</p>
                            <div class="employee-status">
                                {% if employee.is_verified %}
                                    <span class="status-badge verified">
                                        <i class="fas fa-check-circle"></i> Verified
                                    </span>
                                {% else %}
                                    <span class="status-badge pending">
                                        <i class="fas fa-clock"></i> Pending Verification
                                    </span>
                                {% endif %}
                                {% if is_new_employee %}
                                    <span class="status-badge new">
                                        <i class="fas fa-star"></i> New Employee
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="employee-actions">
                        <a href="{% url 'core:employee_directory' %}" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left"></i> Back to Directory
                        </a>
                        <button class="btn btn-primary" onclick="editEmployee({{ employee.id }})">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column - Employee Information -->
            <div class="col-lg-4">
                <!-- Contact Information -->
                <div class="info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-address-book"></i> Contact Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <strong>Email</strong>
                                <p>{{ employee.email }}</p>
                            </div>
                        </div>
                        {% if employee.phone %}
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <strong>Phone</strong>
                                <p>{{ employee.phone }}</p>
                            </div>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <i class="fas fa-id-badge"></i>
                            <div>
                                <strong>Employee ID</strong>
                                <p>{{ employee.employee_id }}</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <strong>Joined Company</strong>
                                <p>{{ employee.created_at|date:"F d, Y" }}</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>Days with Company</strong>
                                <p>{{ days_since_hire }} days</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Overview -->
                <div class="info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Performance Overview</h5>
                    </div>
                    <div class="card-body">
                        {% if performance_metrics %}
                            <div class="performance-summary">
                                <div class="metric-item">
                                    <div class="metric-value">4.2</div>
                                    <div class="metric-label">Average Rating</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">95%</div>
                                    <div class="metric-label">Task Completion</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">12</div>
                                    <div class="metric-label">Projects Completed</div>
                                </div>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-chart-line"></i>
                                <p>No performance data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Related Employees -->
                {% if related_employees %}
                <div class="info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-users"></i> Team Members</h5>
                    </div>
                    <div class="card-body">
                        {% for team_member in related_employees %}
                        <div class="team-member">
                            <div class="member-avatar">
                                <span>{{ team_member.first_name|first }}{{ team_member.last_name|first }}</span>
                            </div>
                            <div class="member-info">
                                <strong>{{ team_member.first_name }} {{ team_member.last_name }}</strong>
                                <p>{{ team_member.position|default:"Position not specified" }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Activity and Details -->
            <div class="col-lg-8">
                <!-- Activity Timeline -->
                <div class="info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Activity Timeline</h5>
                    </div>
                    <div class="card-body">
                        {% if activities %}
                            <div class="timeline">
                                {% for activity in activities %}
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <strong>{{ activity.action|title|replace:"_":" " }}</strong>
                                            <span class="timeline-date">{{ activity.created_at|date:"M d, Y H:i" }}</span>
                                        </div>
                                        <p class="timeline-description">{{ activity.description }}</p>
                                        {% if activity.ip_address %}
                                        <small class="timeline-meta">IP: {{ activity.ip_address }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-history"></i>
                                <p>No activity history available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Projects/Tasks -->
                {% if recent_activities %}
                <div class="info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-tasks"></i> Recent Activities</h5>
                    </div>
                    <div class="card-body">
                        {% for activity in recent_activities %}
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="activity-content">
                                <strong>{{ activity.title|default:"Untitled Task" }}</strong>
                                <p>{{ activity.description|default:"No description available" }}</p>
                                <small class="activity-date">{{ activity.created_at|date:"M d, Y" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Performance Metrics Chart -->
                {% if performance_metrics %}
                <div class="info-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Performance Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel">Edit Employee Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="edit_email" name="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="edit_phone" name="phone">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_department" class="form-label">Department</label>
                                <input type="text" class="form-control" id="edit_department" name="department">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_position" class="form-label">Position</label>
                                <input type="text" class="form-control" id="edit_position" name="position">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_verified" name="is_verified">
                            <label class="form-check-label" for="edit_is_verified">
                                Verified Employee
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateEmployee({{ employee.id }})">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performance Chart
{% if performance_metrics %}
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for metric in performance_metrics %}
            '{{ metric.period_start|date:"M Y" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Performance Score',
            data: [
                {% for metric in performance_metrics %}
                {{ metric.value|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Performance Over Time'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 5
            }
        }
    }
});
{% endif %}

// Edit Employee Functions (reuse from employee directory)
function editEmployee(employeeId) {
    fetch(`{% url "api:get_employee" employee_id=0 %}`.replace('0', employeeId), {
        method: 'GET',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showEditEmployeeModal(data.employee);
        } else {
            showNotification('Error loading employee details: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('An error occurred while loading employee details', 'error');
    });
}

function showEditEmployeeModal(employee) {
    // Populate form fields
    document.getElementById('edit_first_name').value = employee.first_name || '';
    document.getElementById('edit_last_name').value = employee.last_name || '';
    document.getElementById('edit_email').value = employee.email || '';
    document.getElementById('edit_phone').value = employee.phone || '';
    document.getElementById('edit_department').value = employee.department || '';
    document.getElementById('edit_position').value = employee.position || '';
    document.getElementById('edit_is_verified').checked = employee.is_verified || false;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
    modal.show();
}

function updateEmployee(employeeId) {
    const form = document.getElementById('editEmployeeForm');
    const formData = new FormData(form);
    formData.append('is_verified', document.getElementById('edit_is_verified').checked);
    
    fetch(`{% url "api:update_employee" employee_id=0 %}`.replace('0', employeeId), {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'Employee updated successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
            setTimeout(() => { location.reload(); }, 1000);
        } else {
            showNotification(data.error || 'Failed to update employee', 'error');
        }
    })
    .catch(error => {
        showNotification('An error occurred while updating the employee', 'error');
    });
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}
