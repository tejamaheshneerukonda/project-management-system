{% extends 'base_company_admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/notification_center.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-bell"></i>
                Notification Center
            </h1>
            <p class="page-subtitle">Manage and track all company notifications</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="markAllAsRead()">
                <i class="fas fa-check-double"></i> Mark All Read
            </button>
            <button class="btn btn-success" onclick="createNotification()">
                <i class="fas fa-plus"></i> Create Notification
            </button>
        </div>
    </div>

    <!-- Notification Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="notification-stat-card total">
                <div class="stat-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_notifications }}</h3>
                    <p>Total Notifications</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="notification-stat-card unread">
                <div class="stat-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ unread_notifications }}</h3>
                    <p>Unread Notifications</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="notification-stat-card critical">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ critical_notifications }}</h3>
                    <p>Critical Alerts</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="notification-stat-card read">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_notifications|add:"-"|add:unread_notifications }}</h3>
                    <p>Read Notifications</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="notification-filters-card">
                <div class="filters-header">
                    <h5><i class="fas fa-filter"></i> Filters & Search</h5>
                </div>
                <div class="filters-content">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="type" class="form-label">Notification Type</label>
                            <select class="form-select" id="type" name="type">
                                <option value="">All Types</option>
                                {% for type_code, type_name in notification_type_choices %}
                                    <option value="{{ type_code }}" {% if notification_type_filter == type_code %}selected{% endif %}>
                                        {{ type_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="">All Priorities</option>
                                {% for priority_code, priority_name in priority_choices %}
                                    <option value="{{ priority_code }}" {% if priority_filter == priority_code %}selected{% endif %}>
                                        {{ priority_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="unread" {% if status_filter == 'unread' %}selected{% endif %}>Unread</option>
                                <option value="read" {% if status_filter == 'read' %}selected{% endif %}>Read</option>
                                <option value="archived" {% if status_filter == 'archived' %}selected{% endif %}>Archived</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">Date From</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">Date To</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <a href="{% url 'core:notification_center' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="row">
        <div class="col-lg-8">
            <div class="notifications-list-card">
                <div class="list-header">
                    <h5><i class="fas fa-list"></i> Notifications</h5>
                    <div class="list-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="bulkArchive()">
                            <i class="fas fa-archive"></i> Archive Selected
                        </button>
                    </div>
                </div>
                <div class="list-content">
                    {% if notifications %}
                        <div class="notifications-list">
                            {% for notification in notifications %}
                                <div class="notification-item {% if not notification.is_read %}unread{% endif %} priority-{{ notification.priority|lower }}" data-notification-id="{{ notification.id }}">
                                    <div class="notification-checkbox">
                                        <input type="checkbox" class="form-check-input notification-checkbox-input" value="{{ notification.id }}">
                                    </div>
                                    <div class="notification-icon">
                                        {% if notification.priority == 'CRITICAL' %}
                                            <i class="fas fa-exclamation-triangle text-danger"></i>
                                        {% elif notification.priority == 'HIGH' %}
                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                        {% elif notification.priority == 'MEDIUM' %}
                                            <i class="fas fa-info-circle text-info"></i>
                                        {% else %}
                                            <i class="fas fa-bell text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="notification-content">
                                        <div class="notification-header">
                                            <h6 class="notification-title">{{ notification.title }}</h6>
                                            <div class="notification-meta">
                                                <span class="notification-type">{{ notification.get_notification_type_display }}</span>
                                                <span class="notification-priority priority-{{ notification.priority|lower }}">{{ notification.get_priority_display }}</span>
                                                <span class="notification-channel">{{ notification.get_channel_display }}</span>
                                            </div>
                                        </div>
                                        <div class="notification-message">
                                            <p>{{ notification.message|truncatewords:20 }}</p>
                                        </div>
                                        <div class="notification-footer">
                                            <div class="notification-time">
                                                <i class="fas fa-clock"></i>
                                                {{ notification.created_at|timesince }} ago
                                            </div>
                                            {% if notification.action_url %}
                                                <div class="notification-action">
                                                    <a href="{{ notification.action_url }}" class="btn btn-sm btn-outline-primary">
                                                        {{ notification.action_text|default:"View Details" }}
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="notification-actions">
                                        {% if not notification.is_read %}
                                            <button class="btn btn-sm btn-outline-success" onclick="markAsRead({{ notification.id }})" title="Mark as Read">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        {% endif %}
                                        {% if not notification.is_archived %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="archiveNotification({{ notification.id }})" title="Archive">
                                                <i class="fas fa-archive"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNotification({{ notification.id }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Pagination -->
                        {% if notifications.has_other_pages %}
                            <div class="pagination-container">
                                <nav aria-label="Notifications pagination">
                                    <ul class="pagination justify-content-center">
                                        {% if notifications.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page=1{% if notification_type_filter %}&type={{ notification_type_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                                    <i class="fas fa-angle-double-left"></i>
                                                </a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ notifications.previous_page_number }}{% if notification_type_filter %}&type={{ notification_type_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                                    <i class="fas fa-angle-left"></i>
                                                </a>
                                            </li>
                                        {% endif %}
                                        
                                        {% for num in notifications.paginator.page_range %}
                                            {% if notifications.number == num %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                            {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ num }}{% if notification_type_filter %}&type={{ notification_type_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if notifications.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ notifications.next_page_number }}{% if notification_type_filter %}&type={{ notification_type_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                                    <i class="fas fa-angle-right"></i>
                                                </a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ notifications.paginator.num_pages }}{% if notification_type_filter %}&type={{ notification_type_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                                    <i class="fas fa-angle-double-right"></i>
                                                </a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <h5>No notifications found</h5>
                            <p>No notifications match your current filters.</p>
                            <a href="{% url 'core:create_notification' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create First Notification
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Recent Notifications Sidebar -->
        <div class="col-lg-4">
            <div class="recent-notifications-card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Notifications</h5>
                </div>
                <div class="card-content">
                    {% if recent_notifications %}
                        <div class="recent-list">
                            {% for notification in recent_notifications %}
                                <div class="recent-item {% if not notification.is_read %}unread{% endif %}">
                                    <div class="recent-icon">
                                        {% if notification.priority == 'CRITICAL' %}
                                            <i class="fas fa-exclamation-triangle text-danger"></i>
                                        {% elif notification.priority == 'HIGH' %}
                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                        {% else %}
                                            <i class="fas fa-bell text-info"></i>
                                        {% endif %}
                                    </div>
                                    <div class="recent-content">
                                        <h6>{{ notification.title }}</h6>
                                        <p>{{ notification.message|truncatewords:10 }}</p>
                                        <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <p>No recent notifications</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions-card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-content">
                    <div class="quick-actions-list">
                        <a href="{% url 'core:create_notification' %}" class="quick-action-item">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Notification</span>
                        </a>
                        <a href="{% url 'core:notification_templates' %}" class="quick-action-item">
                            <i class="fas fa-file-alt"></i>
                            <span>Manage Templates</span>
                        </a>
                        <a href="{% url 'core:notification_preferences' %}" class="quick-action-item">
                            <i class="fas fa-cog"></i>
                            <span>Notification Settings</span>
                        </a>
                        <a href="{% url 'core:notification_analytics' %}" class="quick-action-item">
                            <i class="fas fa-chart-line"></i>
                            <span>View Analytics</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Detail Modal -->
<div class="modal fade" id="notificationDetailModal" tabindex="-1" aria-labelledby="notificationDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationDetailModalLabel">
                    <i class="fas fa-bell"></i> Notification Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="notificationDetailContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="notificationActionBtn" style="display: none;">
                    <i class="fas fa-external-link-alt"></i> Take Action
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function markAsRead(notificationId) {
    fetch(`/api/notifications/${notificationId}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Notification marked as read', 'success');
            // Update UI
            const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationItem) {
                notificationItem.classList.remove('unread');
                notificationItem.querySelector('.notification-actions .btn-outline-success').remove();
            }
            // Update counters
            updateNotificationCounters();
        } else {
            showNotification(data.error || 'Failed to mark notification as read', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred', 'error');
    });
}

function archiveNotification(notificationId) {
    if (confirm('Are you sure you want to archive this notification?')) {
        fetch(`/api/notifications/${notificationId}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Notification archived', 'success');
                // Remove from UI
                const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.remove();
                }
                // Update counters
                updateNotificationCounters();
            } else {
                showNotification(data.error || 'Failed to archive notification', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    }
}

function deleteNotification(notificationId) {
    if (confirm('Are you sure you want to delete this notification? This action cannot be undone.')) {
        fetch(`/api/notifications/${notificationId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Notification deleted', 'success');
                // Remove from UI
                const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.remove();
                }
                // Update counters
                updateNotificationCounters();
            } else {
                showNotification(data.error || 'Failed to delete notification', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    }
}

function markAllAsRead() {
    if (confirm('Are you sure you want to mark all notifications as read?')) {
        fetch('/api/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('All notifications marked as read', 'success');
                // Update UI
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const markReadBtn = item.querySelector('.notification-actions .btn-outline-success');
                    if (markReadBtn) {
                        markReadBtn.remove();
                    }
                });
                // Update counters
                updateNotificationCounters();
            } else {
                showNotification(data.error || 'Failed to mark notifications as read', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    }
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.notification-checkbox-input');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
    
    const selectAllBtn = document.querySelector('.list-actions .btn-outline-primary');
    selectAllBtn.innerHTML = allChecked ? 
        '<i class="fas fa-check-square"></i> Select All' : 
        '<i class="fas fa-square"></i> Deselect All';
}

function bulkArchive() {
    const selectedIds = Array.from(document.querySelectorAll('.notification-checkbox-input:checked'))
        .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showNotification('Please select notifications to archive', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to archive ${selectedIds.length} notification(s)?`)) {
        fetch('/api/notifications/bulk-archive/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notification_ids: selectedIds }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${selectedIds.length} notification(s) archived`, 'success');
                // Remove from UI
                selectedIds.forEach(id => {
                    const notificationItem = document.querySelector(`[data-notification-id="${id}"]`);
                    if (notificationItem) {
                        notificationItem.remove();
                    }
                });
                // Update counters
                updateNotificationCounters();
            } else {
                showNotification(data.error || 'Failed to archive notifications', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    }
}

function createNotification() {
    window.location.href = "{% url 'core:create_notification' %}";
}

function updateNotificationCounters() {
    // Update unread count
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    const unreadElement = document.querySelector('.notification-stat-card.unread h3');
    if (unreadElement) {
        unreadElement.textContent = unreadCount;
    }
    
    // Update total count
    const totalCount = document.querySelectorAll('.notification-item').length;
    const totalElement = document.querySelector('.notification-stat-card.total h3');
    if (totalElement) {
        totalElement.textContent = totalCount;
    }
    
    // Update read count
    const readCount = totalCount - unreadCount;
    const readElement = document.querySelector('.notification-stat-card.read h3');
    if (readElement) {
        readElement.textContent = readCount;
    }
}

// Auto-refresh notifications every 30 seconds
setInterval(function() {
    // Only refresh if no modal is open and user is on this page
    if (!document.querySelector('.modal.show') && window.location.pathname.includes('notification-center')) {
        // You could implement auto-refresh here if needed
    }
}, 30000);

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for notification items
    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't trigger if clicking on buttons or checkboxes
            if (e.target.closest('.notification-actions') || e.target.closest('.notification-checkbox')) {
                return;
            }
            
            const notificationId = this.dataset.notificationId;
            // You could implement notification detail view here
        });
    });
});
</script>
{% endblock %}
