{% extends 'base_company_admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/performance_dashboard.css' %}">
<style>
    .review-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.1);
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .review-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .review-employee {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .employee-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
    }
    
    .employee-info h6 {
        margin-bottom: 0.25rem;
        color: #333;
        font-weight: 600;
    }
    
    .employee-info p {
        margin-bottom: 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    .review-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-in_progress {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-completed {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-cancelled {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .review-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .detail-item {
        text-align: center;
    }
    
    .detail-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    
    .detail-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }
    
    .review-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.1);
        margin-bottom: 2rem;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.1);
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #666;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-clipboard-check"></i>
                Performance Reviews
            </h1>
            <p class="page-subtitle">Manage and track employee performance reviews</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="createNewReview()">
                <i class="fas fa-plus"></i> New Review
            </button>
            <button class="btn btn-success" onclick="exportReviews()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-number">{{ reviews.paginator.count }}</div>
            <div class="stat-label">Total Reviews</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ reviews|length }}</div>
            <div class="stat-label">Current Page</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ employees.count }}</div>
            <div class="stat-label">Total Employees</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filter-section">
        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filters</h5>
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select name="status" id="status" class="form-select">
                    <option value="">All Statuses</option>
                    {% for value, label in review_status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="review_type" class="form-label">Review Type</label>
                <select name="review_type" id="review_type" class="form-select">
                    <option value="">All Types</option>
                    {% for value, label in review_type_choices %}
                        <option value="{{ value }}" {% if review_type_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="employee" class="form-label">Employee</label>
                <select name="employee" id="employee" class="form-select">
                    <option value="">All Employees</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}" {% if employee_filter == employee.id|stringformat:"s" %}selected{% endif %}>
                            {{ employee.first_name }} {{ employee.last_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Filter
                </button>
                <a href="{% url 'core:performance_reviews' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Reviews List -->
    <div class="row">
        <div class="col-12">
            {% if reviews %}
                {% for review in reviews %}
                    <div class="review-card">
                        <div class="review-header">
                            <div class="review-employee">
                                <div class="employee-avatar">
                                    {{ review.employee.first_name|first }}{{ review.employee.last_name|first }}
                                </div>
                                <div class="employee-info">
                                    <h6>{{ review.employee.first_name }} {{ review.employee.last_name }}</h6>
                                    <p>{{ review.employee.department|default:"No Department" }} â€¢ {{ review.employee.position|default:"No Position" }}</p>
                                </div>
                            </div>
                            <div class="review-status status-{{ review.status|lower }}">
                                {{ review.get_status_display }}
                            </div>
                        </div>
                        
                        <div class="review-details">
                            <div class="detail-item">
                                <div class="detail-label">Review Type</div>
                                <div class="detail-value">{{ review.get_review_type_display }}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Start Date</div>
                                <div class="detail-value">{{ review.start_date|date:"M d, Y" }}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">End Date</div>
                                <div class="detail-value">{{ review.end_date|date:"M d, Y" }}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Overall Rating</div>
                                <div class="detail-value">
                                    {% if review.overall_rating %}
                                        {{ review.overall_rating }}/5
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="review-actions">
                            <a href="{% url 'core:employee_performance_detail' review.employee.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            {% if review.status == 'PENDING' %}
                                <button class="btn btn-warning btn-sm" onclick="startReview({{ review.id }})">
                                    <i class="fas fa-play"></i> Start Review
                                </button>
                            {% elif review.status == 'IN_PROGRESS' %}
                                <button class="btn btn-success btn-sm" onclick="completeReview({{ review.id }})">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                            {% endif %}
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteReview({{ review.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if reviews.has_other_pages %}
                    <nav aria-label="Reviews pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if reviews.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if status_filter %}&status={{ status_filter }}{% endif %}{% if review_type_filter %}&review_type={{ review_type_filter }}{% endif %}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ reviews.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if review_type_filter %}&review_type={{ review_type_filter }}{% endif %}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ reviews.number }} of {{ reviews.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if reviews.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ reviews.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if review_type_filter %}&review_type={{ review_type_filter }}{% endif %}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ reviews.paginator.num_pages }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if review_type_filter %}&review_type={{ review_type_filter }}{% endif %}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <p>No performance reviews found</p>
                    <button class="btn btn-primary" onclick="createNewReview()">
                        <i class="fas fa-plus"></i> Create First Review
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Review Modal -->
<div class="modal fade" id="createReviewModal" tabindex="-1" aria-labelledby="createReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createReviewModalLabel">
                    <i class="fas fa-plus"></i> Create New Performance Review
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createReviewForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="employee_select" class="form-label">Employee</label>
                            <select class="form-select" id="employee_select" required>
                                <option value="">Select Employee</option>
                                {% for employee in employees %}
                                    <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="review_type_select" class="form-label">Review Type</label>
                            <select class="form-select" id="review_type_select" required>
                                <option value="">Select Type</option>
                                {% for value, label in review_type_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" required>
                        </div>
                        <div class="col-12">
                            <label for="review_notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="review_notes" rows="3" placeholder="Additional notes for this review..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateReview()">Create Review</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function createNewReview() {
    const modal = new bootstrap.Modal(document.getElementById('createReviewModal'));
    modal.show();
}

function submitCreateReview() {
    const form = document.getElementById('createReviewForm');
    const formData = new FormData();
    
    formData.append('employee_id', document.getElementById('employee_select').value);
    formData.append('review_type', document.getElementById('review_type_select').value);
    formData.append('start_date', document.getElementById('start_date').value);
    formData.append('end_date', document.getElementById('end_date').value);
    formData.append('notes', document.getElementById('review_notes').value);
    
    // Show loading state
    const submitBtn = document.querySelector('#createReviewModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    submitBtn.disabled = true;
    
    fetch('{% url "api:create_performance" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            showErrorToast('Error creating review: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('An error occurred while creating the review');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function startReview(reviewId) {
    if (confirm('Are you sure you want to start this review?')) {
        // Implementation for starting review
        console.log('Starting review:', reviewId);
    }
}

function completeReview(reviewId) {
    if (confirm('Are you sure you want to complete this review?')) {
        // Implementation for completing review
        console.log('Completing review:', reviewId);
    }
}

function deleteReview(reviewId) {
    if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
        // Implementation for deleting review
        console.log('Deleting review:', reviewId);
    }
}

function exportReviews() {
    // Get current filter parameters
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status') || '';
    const reviewType = urlParams.get('review_type') || '';
    const employee = urlParams.get('employee') || '';
    
    // Build export URL with current filters
    let exportUrl = '{% url "api:export_performance_reviews" %}?';
    if (status) exportUrl += `status=${status}&`;
    if (reviewType) exportUrl += `review_type=${reviewType}&`;
    if (employee) exportUrl += `employee=${employee}&`;
    
    // Remove trailing & if present
    exportUrl = exportUrl.replace(/&$/, '');
    
    // Create download link
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = 'performance_reviews.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}
