{% extends 'base_company_admin.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/attendance_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid attendance-dashboard-wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-clock"></i>
                Attendance Dashboard
            </h1>
            <p class="page-subtitle">Real-time attendance tracking and management</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="showAttendanceReportModal()">
                <i class="fas fa-chart-bar"></i> Generate Report
            </button>
            <button class="btn btn-success" onclick="createLeaveRequest()">
                <i class="fas fa-plus"></i> New Leave Request
            </button>
        </div>
    </div>

    <!-- Today's Attendance Overview -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="attendance-card present">
                <div class="card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-content">
                    <h3>{{ present_today }}</h3>
                    <p>Present Today</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="attendance-card absent">
                <div class="card-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="card-content">
                    <h3>{{ absent_today }}</h3>
                    <p>Absent Today</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="attendance-card late">
                <div class="card-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="card-content">
                    <h3>{{ late_today }}</h3>
                    <p>Late Today</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="attendance-card leave">
                <div class="card-icon">
                    <i class="fas fa-calendar-times"></i>
                </div>
                <div class="card-content">
                    <h3>{{ on_leave_today }}</h3>
                    <p>On Leave Today</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Currently Clocked In -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="attendance-section-card">
                <div class="section-header">
                    <h5><i class="fas fa-clock"></i> Currently Clocked In</h5>
                    <span class="badge bg-success">{{ clocked_in_employees.count }}</span>
                </div>
                <div class="section-content">
                    {% if clocked_in_employees %}
                        <div class="clocked-in-list">
                            {% for attendance in clocked_in_employees %}
                                <div class="clocked-in-item">
                                    <div class="employee-info">
                                        <div class="employee-avatar">
                                            {% if attendance.employee.photo %}
                                                <img src="{{ attendance.employee.photo.url }}" alt="{{ attendance.employee.first_name }} {{ attendance.employee.last_name }}" class="avatar-image">
                                            {% else %}
                                                <span class="avatar-initials">{{ attendance.employee.get_initials }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="employee-details">
                                            <h6>{{ attendance.employee.first_name }} {{ attendance.employee.last_name }}</h6>
                                            <p>{{ attendance.employee.department|default:"No Department" }}</p>
                                        </div>
                                    </div>
                                    <div class="clock-info">
                                        <div class="clock-time">
                                            <span class="clock-label">Clocked In:</span>
                                            <span class="clock-value">{{ attendance.clock_in|time:"H:i" }}</span>
                                        </div>
                                        <div class="duration">
                                            <span class="duration-label">Duration:</span>
                                            <span class="duration-value" id="duration-{{ attendance.id }}">
                                                <script>
                                                    calculateDuration('{{ attendance.clock_in|date:"c" }}', 'duration-{{ attendance.id }}');
                                                </script>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="clock-status">
                                        {% if attendance.is_on_break %}
                                            <span class="status-badge break">On Break</span>
                                        {% else %}
                                            <span class="status-badge working">Working</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No employees currently clocked in</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Statistics -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="attendance-stat-card">
                <div class="stat-header">
                    <h5><i class="fas fa-chart-pie"></i> Monthly Statistics</h5>
                </div>
                <div class="stat-content">
                    <div class="stat-item">
                        <span class="stat-label">Total Working Days:</span>
                        <span class="stat-value">{{ total_working_days }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Hours Worked:</span>
                        <span class="stat-value">{{ total_hours_worked|floatformat:1 }}h</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average Hours/Day:</span>
                        <span class="stat-value">
                            {% if total_working_days > 0 %}
                                {% widthratio total_hours_worked total_working_days 1|floatformat:1 %}h
                            {% else %}
                                0h
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-3">
            <div class="attendance-stat-card">
                <div class="stat-header">
                    <h5><i class="fas fa-calendar-times"></i> Leave Management</h5>
                </div>
                <div class="stat-content">
                    <div class="stat-item">
                        <span class="stat-label">Pending Requests:</span>
                        <span class="stat-value">{{ pending_leaves }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Upcoming Leaves:</span>
                        <span class="stat-value">{{ upcoming_leaves.count }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Employees:</span>
                        <span class="stat-value">{{ total_employees }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-lg-6 mb-3">
            <div class="attendance-section-card">
                <div class="section-header">
                    <h5><i class="fas fa-history"></i> Recent Attendance</h5>
                    <a href="{% url 'core:attendance_records' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="section-content">
                    {% if recent_attendance %}
                        <div class="activity-list">
                            {% for attendance in recent_attendance %}
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        {% if attendance.status == 'PRESENT' %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% elif attendance.status == 'ABSENT' %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% elif attendance.status == 'LATE' %}
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                        {% elif attendance.status == 'ON_LEAVE' %}
                                            <i class="fas fa-calendar-times text-info"></i>
                                        {% else %}
                                            <i class="fas fa-question-circle text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="activity-content">
                                        <h6>{{ attendance.employee.first_name }} {{ attendance.employee.last_name }}</h6>
                                        <p>{{ attendance.get_status_display }} - {{ attendance.date|date:"M d, Y" }}</p>
                                        {% if attendance.clock_in and attendance.clock_out %}
                                            <small>{{ attendance.clock_in|time:"H:i" }} - {{ attendance.clock_out|time:"H:i" }} ({{ attendance.total_hours|floatformat:1 }}h)</small>
                                        {% elif attendance.clock_in %}
                                            <small>Clocked in at {{ attendance.clock_in|time:"H:i" }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="activity-status">
                                        <span class="status-badge status-{{ attendance.status|lower }}">{{ attendance.get_status_display }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>No recent attendance records</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-3">
            <div class="attendance-section-card">
                <div class="section-header">
                    <h5><i class="fas fa-calendar-alt"></i> Upcoming Leaves</h5>
                    <a href="{% url 'core:leave_management' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="section-content">
                    {% if upcoming_leaves %}
                        <div class="activity-list">
                            {% for leave in upcoming_leaves %}
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-calendar-times text-info"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6>{{ leave.employee.first_name }} {{ leave.employee.last_name }}</h6>
                                        <p>{{ leave.get_leave_type_display }}</p>
                                        <small>{{ leave.start_date|date:"M d" }} - {{ leave.end_date|date:"M d, Y" }} ({{ leave.total_days }} days)</small>
                                    </div>
                                    <div class="activity-status">
                                        <span class="status-badge status-approved">{{ leave.get_status_display }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <p>No upcoming leaves</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Report Modal -->
<div class="modal fade" id="attendanceReportModal" tabindex="-1" aria-labelledby="attendanceReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attendanceReportModalLabel">
                    <i class="fas fa-chart-bar"></i> Generate Attendance Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="attendanceReportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportType" class="form-label">Report Type</label>
                                <select class="form-select" id="reportType" name="report_type">
                                    <option value="DAILY">Daily Attendance</option>
                                    <option value="WEEKLY">Weekly Summary</option>
                                    <option value="MONTHLY">Monthly Report</option>
                                    <option value="EMPLOYEE">Employee Attendance</option>
                                    <option value="DEPARTMENT">Department Summary</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportFormat" class="form-label">Report Format</label>
                                <select class="form-select" id="reportFormat" name="format">
                                    <option value="PDF">PDF Document</option>
                                    <option value="EXCEL">Excel Spreadsheet</option>
                                    <option value="CSV">CSV File</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="start_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="end_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Include Data</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeAttendance" name="include_attendance" checked>
                            <label class="form-check-label" for="includeAttendance">Attendance Records</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeLeaves" name="include_leaves" checked>
                            <label class="form-check-label" for="includeLeaves">Leave Requests</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeTimesheets" name="include_timesheets" checked>
                            <label class="form-check-label" for="includeTimesheets">Timesheet Entries</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeShifts" name="include_shifts" checked>
                            <label class="form-check-label" for="includeShifts">Shift Assignments</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateAttendanceReport()">
                    <i class="fas fa-download"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Ensure attendance dashboard has proper readability
document.addEventListener('DOMContentLoaded', function() {
    // Force light theme wrapper if needed
    const wrapper = document.querySelector('.attendance-dashboard-wrapper');
    if (wrapper) {
        // Add force-light-theme class to ensure readability
        wrapper.classList.add('force-light-theme');
        
        // Force all modals to be light theme
        const modals = wrapper.querySelectorAll('.modal-content');
        modals.forEach(modal => {
            modal.style.backgroundColor = '#ffffff';
            modal.style.color = '#1f2937';
        });
        
        const modalHeaders = wrapper.querySelectorAll('.modal-header');
        modalHeaders.forEach(header => {
            header.style.backgroundColor = '#f9fafb';
            header.style.color = '#1f2937';
        });
        
        const modalBodies = wrapper.querySelectorAll('.modal-body');
        modalBodies.forEach(body => {
            body.style.backgroundColor = '#ffffff';
            body.style.color = '#1f2937';
        });
        
        const modalFooters = wrapper.querySelectorAll('.modal-footer');
        modalFooters.forEach(footer => {
            footer.style.backgroundColor = '#f9fafb';
            footer.style.color = '#1f2937';
        });
        
        // Force all form elements to be light theme
        const formLabels = wrapper.querySelectorAll('.form-label');
        formLabels.forEach(label => {
            label.style.color = '#374151';
        });
        
        const formControls = wrapper.querySelectorAll('.form-control, .form-select');
        formControls.forEach(control => {
            control.style.backgroundColor = '#ffffff';
            control.style.borderColor = '#d1d5db';
            control.style.color = '#1f2937';
        });
        
        // Remove dark theme if it's causing issues
        if (document.body.classList.contains('dark-theme')) {
            // Check if text is readable
            const testElement = document.createElement('div');
            testElement.style.position = 'absolute';
            testElement.style.left = '-9999px';
            testElement.style.color = 'inherit';
            testElement.style.backgroundColor = 'inherit';
            testElement.textContent = 'Test';
            wrapper.appendChild(testElement);
            
            const computedStyle = window.getComputedStyle(testElement);
            const textColor = computedStyle.color;
            const bgColor = computedStyle.backgroundColor;
            
            wrapper.removeChild(testElement);
            
            // If colors are too similar or black, force light theme
            if (textColor === bgColor || textColor === 'rgb(0, 0, 0)' || bgColor === 'rgb(0, 0, 0)') {
                console.log('Detected readability issues on attendance dashboard, applying fixes');
                wrapper.classList.add('force-light-theme');
            }
        }
    }
});

function showAttendanceReportModal() {
    const modal = new bootstrap.Modal(document.getElementById('attendanceReportModal'));
    
    // Force light theme styling when modal is shown
    modal._element.addEventListener('shown.bs.modal', function() {
        const modalContent = document.querySelector('#attendanceReportModal .modal-content');
        const modalHeader = document.querySelector('#attendanceReportModal .modal-header');
        const modalBody = document.querySelector('#attendanceReportModal .modal-body');
        const modalFooter = document.querySelector('#attendanceReportModal .modal-footer');
        
        if (modalContent) {
            modalContent.style.backgroundColor = '#ffffff';
            modalContent.style.color = '#1f2937';
        }
        
        if (modalHeader) {
            modalHeader.style.backgroundColor = '#f9fafb';
            modalHeader.style.color = '#1f2937';
        }
        
        if (modalBody) {
            modalBody.style.backgroundColor = '#ffffff';
            modalBody.style.color = '#1f2937';
        }
        
        if (modalFooter) {
            modalFooter.style.backgroundColor = '#f9fafb';
            modalFooter.style.color = '#1f2937';
        }
        
        // Force all form elements to be light theme
        const formLabels = document.querySelectorAll('#attendanceReportModal .form-label');
        formLabels.forEach(label => {
            label.style.color = '#374151';
        });
        
        const formControls = document.querySelectorAll('#attendanceReportModal .form-control, #attendanceReportModal .form-select');
        formControls.forEach(control => {
            control.style.backgroundColor = '#ffffff';
            control.style.borderColor = '#d1d5db';
            control.style.color = '#1f2937';
        });
        
        const formCheckLabels = document.querySelectorAll('#attendanceReportModal .form-check-label');
        formCheckLabels.forEach(label => {
            label.style.color = '#374151';
        });
        
        console.log('Applied light theme to attendance report modal');
    });
    
    modal.show();
}

function createLeaveRequest() {
    // Redirect to create new leave request page
    window.location.href = "{% url 'core:leave_management' %}";
}

function generateAttendanceReport() {
    const form = document.getElementById('attendanceReportForm');
    const formData = new FormData(form);
    
    // Add CSRF token
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Show loading state
    const generateBtn = document.querySelector('#attendanceReportModal .btn-primary');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    generateBtn.disabled = true;
    
    fetch('{% url "api:generate_attendance_report" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Report generated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('attendanceReportModal')).hide();
            
            // Download the report
            if (data.report_url) {
                window.open(data.report_url, '_blank');
            }
        } else {
            showNotification(data.error || 'Failed to generate report', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while generating the report', 'error');
    })
    .finally(() => {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    });
}

function calculateDuration(clockInTime, elementId) {
    const clockIn = new Date(clockInTime);
    const now = new Date();
    const diff = now - clockIn;
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    const durationElement = document.getElementById(elementId);
    if (durationElement) {
        durationElement.textContent = `${hours}h ${minutes}m`;
    }
}

// Update durations every minute
setInterval(function() {
    document.querySelectorAll('[id^="duration-"]').forEach(function(element) {
        const clockInTime = element.getAttribute('data-clock-in');
        if (clockInTime) {
            calculateDuration(clockInTime, element.id);
        }
    });
}, 60000);

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
});
</script>
{% endblock %}
