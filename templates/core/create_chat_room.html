{% extends 'base_employee.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .create-room-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    .form-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .form-section h5 {
        color: #2c3e50;
        margin-bottom: 25px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
        display: flex;
        align-items: center;
    }
    
    .form-section h5 i {
        margin-right: 10px;
        color: #3498db;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 12px 15px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3498db, #2980b9);
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #2980b9, #1f5f8b);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .participant-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .participant-card:hover {
        border-color: #3498db;
        background: #f8f9fa;
    }
    
    .participant-card.selected {
        border-color: #3498db;
        background: #e3f2fd;
    }
    
    .participant-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
        margin-right: 15px;
    }
    
    .participant-info h6 {
        margin: 0;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .participant-info p {
        margin: 0;
        color: #6c757d;
        font-size: 13px;
    }
    
    .room-type-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }
    
    .room-type-card:hover {
        border-color: #3498db;
        background: #f8f9fa;
    }
    
    .room-type-card.selected {
        border-color: #3498db;
        background: #e3f2fd;
    }
    
    .room-type-icon {
        font-size: 32px;
        margin-bottom: 10px;
        color: #3498db;
    }
    
    .room-type-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .room-type-description {
        font-size: 13px;
        color: #6c757d;
    }
    
    .selected-participants {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .selected-participant {
        display: inline-flex;
        align-items: center;
        background: #3498db;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        margin: 2px;
        font-size: 12px;
    }
    
    .selected-participant .remove {
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .required-field::after {
        content: " *";
        color: #e74c3c;
        font-weight: bold;
    }
    
    .search-box {
        position: relative;
        margin-bottom: 20px;
    }
    
    .search-box .form-control {
        padding-left: 40px;
    }
    
    .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="create-room-container">
    <!-- Header -->
    <div class="text-center mb-4">
        <h2 class="mb-2">
            <i class="fas fa-plus-circle text-primary me-2"></i>
            Create Chat Room
        </h2>
        <p class="text-muted">Start a new conversation with your team members</p>
    </div>

    <form method="post" id="createRoomForm">
        {% csrf_token %}
        
        <!-- Room Details -->
        <div class="form-section">
            <h5><i class="fas fa-info-circle"></i>Room Details</h5>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="room_name" class="form-label required-field">Room Name</label>
                        <input type="text" class="form-control" id="room_name" name="room_name" 
                               placeholder="Enter room name..." required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="room_type" class="form-label">Room Type</label>
                        <select class="form-control" id="room_type" name="room_type">
                            {% for value, label in room_types %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="description" class="form-label">Description (Optional)</label>
                <textarea class="form-control" id="description" name="description" rows="3" 
                          placeholder="Describe the purpose of this room..."></textarea>
            </div>
        </div>

        <!-- Room Type Selection -->
        <div class="form-section">
            <h5><i class="fas fa-layer-group"></i>Room Type</h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="room-type-card" onclick="selectRoomType('GROUP')">
                        <div class="room-type-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="room-type-title">Group Chat</div>
                        <div class="room-type-description">Multiple team members</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="room-type-card" onclick="selectRoomType('DEPARTMENT')">
                        <div class="room-type-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="room-type-title">Department Chat</div>
                        <div class="room-type-description">Department-wide communication</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="room-type-card" onclick="selectRoomType('PROJECT')">
                        <div class="room-type-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="room-type-title">Project Chat</div>
                        <div class="room-type-description">Project-specific discussions</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="room-type-card" onclick="selectRoomType('COMPANY')">
                        <div class="room-type-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="room-type-title">Company Wide</div>
                        <div class="room-type-description">All company members</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participants Selection -->
        <div class="form-section">
            <h5><i class="fas fa-user-plus"></i>Add Participants</h5>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="participantSearch" 
                       placeholder="Search employees..." onkeyup="filterParticipants()">
            </div>
            
            <div class="row" id="participantsList">
                {% for employee in available_employees %}
                <div class="col-md-6">
                    <div class="participant-card" onclick="toggleParticipant({{ employee.id }}, this)">
                        <div class="d-flex align-items-center">
                            <div class="participant-avatar">
                                {{ employee.first_name|first|upper }}
                            </div>
                            <div class="participant-info">
                                <h6>{{ employee.first_name }} {{ employee.last_name }}</h6>
                                <p>{{ employee.position|default:"Employee" }} â€¢ {{ employee.department|default:"No Department" }}</p>
                            </div>
                        </div>
                        <input type="checkbox" name="participants" value="{{ employee.id }}" style="display: none;">
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div id="selectedParticipants" class="selected-participants" style="display: none;">
                <h6 class="mb-2">Selected Participants:</h6>
                <div id="selectedList"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-section">
            <div class="d-flex justify-content-between">
                <a href="{% url 'core:chat_dashboard' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create Room
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedParticipants = [];

// Select room type
function selectRoomType(type) {
    document.getElementById('room_type').value = type;
    
    // Update visual selection
    document.querySelectorAll('.room-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
}

// Toggle participant selection
function toggleParticipant(employeeId, element) {
    const checkbox = element.querySelector('input[type="checkbox"]');
    const isSelected = checkbox.checked;
    
    if (isSelected) {
        checkbox.checked = false;
        element.classList.remove('selected');
        selectedParticipants = selectedParticipants.filter(id => id !== employeeId);
    } else {
        checkbox.checked = true;
        element.classList.add('selected');
        selectedParticipants.push(employeeId);
    }
    
    updateSelectedParticipants();
}

// Update selected participants display
function updateSelectedParticipants() {
    const container = document.getElementById('selectedParticipants');
    const list = document.getElementById('selectedList');
    
    if (selectedParticipants.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    // Get participant names
    const participantNames = selectedParticipants.map(id => {
        const element = document.querySelector(`input[value="${id}"]`).closest('.participant-card');
        const name = element.querySelector('h6').textContent;
        return { id, name };
    });
    
    list.innerHTML = participantNames.map(participant => `
        <span class="selected-participant">
            ${participant.name}
            <span class="remove" onclick="removeParticipant(${participant.id})">Ã—</span>
        </span>
    `).join('');
}

// Remove participant
function removeParticipant(employeeId) {
    const element = document.querySelector(`input[value="${employeeId}"]`).closest('.participant-card');
    toggleParticipant(employeeId, element);
}

// Filter participants
function filterParticipants() {
    const searchTerm = document.getElementById('participantSearch').value.toLowerCase();
    const participantCards = document.querySelectorAll('.participant-card');
    
    participantCards.forEach(card => {
        const name = card.querySelector('h6').textContent.toLowerCase();
        const position = card.querySelector('p').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || position.includes(searchTerm)) {
            card.closest('.col-md-6').style.display = 'block';
        } else {
            card.closest('.col-md-6').style.display = 'none';
        }
    });
}

// Form validation
document.getElementById('createRoomForm').addEventListener('submit', function(e) {
    const roomName = document.getElementById('room_name').value.trim();
    
    if (!roomName) {
        e.preventDefault();
        showErrorToast('Room name is required');
        return false;
    }
    
    if (roomName.length < 3) {
        e.preventDefault();
        showErrorToast('Room name must be at least 3 characters long');
        return false;
    }
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
    submitBtn.disabled = true;
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set default room type
    selectRoomType('GROUP');
    
    // Focus on room name input
    document.getElementById('room_name').focus();
});
</script>
{% endblock %}
